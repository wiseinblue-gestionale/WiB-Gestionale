<!DOCTYPE html>
<!-- saved from url=(0128)file:///C:/Users/faure/OneDrive/Documenti/Lavoro/Wise%20in%20Blue/Gestionale%202026/programma/1/wib-gestionale-github/index.html -->
<html lang="it"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WiB - Wise in Blue | Gestione Finanziaria</title>
    <style>
        :root {
          /* Primitive Color Tokens */
          --color-white: rgba(255, 255, 255, 1);
          --color-black: rgba(0, 0, 0, 1);
          --color-cream-50: rgba(252, 252, 249, 1);
          --color-cream-100: rgba(255, 255, 253, 1);
          --color-gray-200: rgba(245, 245, 245, 1);
          --color-gray-300: rgba(167, 169, 169, 1);
          --color-gray-400: rgba(119, 124, 124, 1);
          --color-slate-500: rgba(98, 108, 113, 1);
          --color-brown-600: rgba(94, 82, 64, 1);
          --color-charcoal-700: rgba(31, 33, 33, 1);
          --color-charcoal-800: rgba(38, 40, 40, 1);
          --color-slate-900: rgba(19, 52, 59, 1);
          --color-teal-300: rgba(50, 184, 198, 1);
          --color-teal-400: rgba(45, 166, 178, 1);
          --color-teal-500: rgba(33, 128, 141, 1);
          --color-teal-600: rgba(29, 116, 128, 1);
          --color-teal-700: rgba(26, 104, 115, 1);
          --color-teal-800: rgba(41, 150, 161, 1);
          --color-red-400: rgba(255, 84, 89, 1);
          --color-red-500: rgba(192, 21, 47, 1);
          --color-orange-400: rgba(230, 129, 97, 1);
          --color-orange-500: rgba(168, 75, 47, 1);
        
          /* RGB versions for opacity control */
          --color-brown-600-rgb: 94, 82, 64;
          --color-teal-500-rgb: 33, 128, 141;
          --color-slate-900-rgb: 19, 52, 59;
          --color-slate-500-rgb: 98, 108, 113;
          --color-red-500-rgb: 192, 21, 47;
          --color-red-400-rgb: 255, 84, 89;
          --color-orange-500-rgb: 168, 75, 47;
          --color-orange-400-rgb: 230, 129, 97;
        
          /* Background color tokens (Light Mode) */
          --color-bg-1: rgba(59, 130, 246, 0.08);
          --color-bg-2: rgba(245, 158, 11, 0.08);
          --color-bg-3: rgba(34, 197, 94, 0.08);
          --color-bg-4: rgba(239, 68, 68, 0.08);
          --color-bg-5: rgba(147, 51, 234, 0.08);
          --color-bg-6: rgba(249, 115, 22, 0.08);
          --color-bg-7: rgba(236, 72, 153, 0.08);
          --color-bg-8: rgba(6, 182, 212, 0.08);
        
          /* Semantic Color Tokens (Light Mode) */
          --color-background: var(--color-cream-50);
          --color-surface: var(--color-cream-100);
          --color-text: var(--color-slate-900);
          --color-text-secondary: var(--color-slate-500);
          --color-primary: var(--color-teal-500);
          --color-primary-hover: var(--color-teal-600);
          --color-primary-active: var(--color-teal-700);
          --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
          --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
          --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
          --color-border: rgba(var(--color-brown-600-rgb), 0.2);
          --color-btn-primary-text: var(--color-cream-50);
          --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
          --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
          --color-error: var(--color-red-500);
          --color-success: var(--color-teal-500);
          --color-warning: var(--color-orange-500);
          --color-info: var(--color-slate-500);
          --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
          --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);
        
          /* Common style patterns */
          --focus-ring: 0 0 0 3px var(--color-focus-ring);
          --focus-outline: 2px solid var(--color-primary);
          --status-bg-opacity: 0.15;
          --status-border-opacity: 0.25;
          --select-caret-light: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
          --select-caret-dark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23f5f5f5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        
          /* RGB versions for opacity control */
          --color-success-rgb: 33, 128, 141;
          --color-error-rgb: 192, 21, 47;
          --color-warning-rgb: 168, 75, 47;
          --color-info-rgb: 98, 108, 113;
        
          /* Typography */
          --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system,
            BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
          --font-family-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo,
            Monaco, Consolas, monospace;
          --font-size-xs: 11px;
          --font-size-sm: 12px;
          --font-size-base: 14px;
          --font-size-md: 14px;
          --font-size-lg: 16px;
          --font-size-xl: 18px;
          --font-size-2xl: 20px;
          --font-size-3xl: 24px;
          --font-size-4xl: 30px;
          --font-weight-normal: 400;
          --font-weight-medium: 500;
          --font-weight-semibold: 550;
          --font-weight-bold: 600;
          --line-height-tight: 1.2;
          --line-height-normal: 1.5;
          --letter-spacing-tight: -0.01em;
        
          /* Spacing */
          --space-0: 0;
          --space-1: 1px;
          --space-2: 2px;
          --space-4: 4px;
          --space-6: 6px;
          --space-8: 8px;
          --space-10: 10px;
          --space-12: 12px;
          --space-16: 16px;
          --space-20: 20px;
          --space-24: 24px;
          --space-32: 32px;
        
          /* Border Radius */
          --radius-sm: 6px;
          --radius-base: 8px;
          --radius-md: 10px;
          --radius-lg: 12px;
          --radius-full: 9999px;
        
          /* Shadows */
          --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
          --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
          --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04),
            0 2px 4px -1px rgba(0, 0, 0, 0.02);
          --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04),
            0 4px 6px -2px rgba(0, 0, 0, 0.02);
          --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.15),
            inset 0 -1px 0 rgba(0, 0, 0, 0.03);
        
          /* Animation */
          --duration-fast: 150ms;
          --duration-normal: 250ms;
          --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);
        
          /* Layout */
          --container-sm: 640px;
          --container-md: 768px;
          --container-lg: 1024px;
          --container-xl: 1280px;
        }
        
        @media (prefers-color-scheme: dark) {
          :root {
            --color-gray-400-rgb: 119, 124, 124;
            --color-teal-300-rgb: 50, 184, 198;
            --color-gray-300-rgb: 167, 169, 169;
            --color-gray-200-rgb: 245, 245, 245;
        
            --color-bg-1: rgba(29, 78, 216, 0.15);
            --color-bg-2: rgba(180, 83, 9, 0.15);
            --color-bg-3: rgba(21, 128, 61, 0.15);
            --color-bg-4: rgba(185, 28, 28, 0.15);
            --color-bg-5: rgba(107, 33, 168, 0.15);
            --color-bg-6: rgba(194, 65, 12, 0.15);
            --color-bg-7: rgba(190, 24, 93, 0.15);
            --color-bg-8: rgba(8, 145, 178, 0.15);
        
            --color-background: var(--color-charcoal-700);
            --color-surface: var(--color-charcoal-800);
            --color-text: var(--color-gray-200);
            --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
            --color-primary: var(--color-teal-300);
            --color-primary-hover: var(--color-teal-400);
            --color-primary-active: var(--color-teal-800);
            --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
            --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
            --color-secondary-active: rgba(var(--color-gray-400-rgb), 0.3);
            --color-border: rgba(var(--color-gray-400-rgb), 0.3);
            --color-error: var(--color-red-400);
            --color-success: var(--color-teal-300);
            --color-warning: var(--color-orange-400);
            --color-info: var(--color-gray-300);
            --color-focus-ring: rgba(var(--color-teal-300-rgb), 0.4);
            --color-btn-primary-text: var(--color-slate-900);
            --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
            --color-card-border-inner: rgba(var(--color-gray-400-rgb), 0.15);
            --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.1),
              inset 0 -1px 0 rgba(0, 0, 0, 0.15);
            --color-border-secondary: rgba(var(--color-gray-400-rgb), 0.2);
            --color-select-caret: rgba(var(--color-gray-200-rgb), 0.8);
        
            --color-success-rgb: var(--color-teal-300-rgb);
            --color-error-rgb: var(--color-red-400-rgb);
            --color-warning-rgb: var(--color-orange-400-rgb);
            --color-info-rgb: var(--color-gray-300-rgb);
          }
        }
        
        html {
          font-size: var(--font-size-base);
          font-family: var(--font-family-base);
          line-height: var(--line-height-normal);
          color: var(--color-text);
          background-color: var(--color-background);
          -webkit-font-smoothing: antialiased;
          box-sizing: border-box;
        }
        
        body {
          margin: 0;
          padding: 0;
        }
        
        *,
        *::before,
        *::after {
          box-sizing: inherit;
        }
        
        h1, h2, h3, h4, h5, h6 {
          margin: 0;
          font-weight: var(--font-weight-semibold);
          line-height: var(--line-height-tight);
          color: var(--color-text);
          letter-spacing: var(--letter-spacing-tight);
        }
        
        h1 { font-size: var(--font-size-4xl); }
        h2 { font-size: var(--font-size-3xl); }
        h3 { font-size: var(--font-size-2xl); }
        h4 { font-size: var(--font-size-xl); }
        h5 { font-size: var(--font-size-lg); }
        h6 { font-size: var(--font-size-md); }
        
        .btn {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          padding: var(--space-8) var(--space-16);
          border-radius: var(--radius-base);
          font-size: var(--font-size-base);
          font-weight: 500;
          line-height: 1.5;
          cursor: pointer;
          transition: all var(--duration-normal) var(--ease-standard);
          border: none;
          text-decoration: none;
          position: relative;
        }
        
        .btn--primary {
          background: var(--color-primary);
          color: var(--color-btn-primary-text);
        }
        
        .btn--primary:hover {
          background: var(--color-primary-hover);
        }
        
        .btn--secondary {
          background: var(--color-secondary);
          color: var(--color-text);
        }
        
        .btn--secondary:hover {
          background: var(--color-secondary-hover);
        }
        
        .btn--sm {
          padding: var(--space-4) var(--space-12);
          font-size: var(--font-size-sm);
          border-radius: var(--radius-sm);
        }
        
        .form-control {
          display: block;
          width: 100%;
          padding: var(--space-8) var(--space-12);
          font-size: var(--font-size-md);
          line-height: 1.5;
          color: var(--color-text);
          background-color: var(--color-surface);
          border: 1px solid var(--color-border);
          border-radius: var(--radius-base);
          transition: border-color var(--duration-fast) var(--ease-standard);
        }
        
        .form-control:focus {
          border-color: var(--color-primary);
          outline: var(--focus-outline);
        }
        
        select.form-control {
          -webkit-appearance: none;
          -moz-appearance: none;
          appearance: none;
          background-image: var(--select-caret-light);
          background-repeat: no-repeat;
          background-position: right var(--space-12) center;
          background-size: 16px;
          padding-right: var(--space-32);
        }
        
        .form-label {
          display: block;
          margin-bottom: var(--space-8);
          font-weight: var(--font-weight-medium);
          font-size: var(--font-size-sm);
        }
        
        .card {
          background-color: var(--color-surface);
          border-radius: var(--radius-lg);
          border: 1px solid var(--color-card-border);
          box-shadow: var(--shadow-sm);
          overflow: hidden;
        }
        
        .card__body {
          padding: var(--space-16);
        }

        /* App specific styles */
        .app {
          min-height: 100vh;
          display: flex;
          flex-direction: column;
        }
        
        .navbar {
          background-color: var(--color-surface);
          border-bottom: 1px solid var(--color-border);
          padding: 0;
          box-shadow: var(--shadow-sm);
        }
        
        .navbar__container {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: var(--space-12) var(--space-24);
          max-width: 1280px;
          margin: 0 auto;
          width: 100%;
        }
        
        .navbar__brand {
          font-size: var(--font-size-xl);
          font-weight: var(--font-weight-bold);
          color: var(--color-primary);
          text-decoration: none;
        }
        
        .navbar__nav {
          display: flex;
          list-style: none;
          margin: 0;
          padding: 0;
          gap: var(--space-4);
        }
        
        .navbar__link {
          display: flex;
          align-items: center;
          padding: var(--space-8) var(--space-16);
          color: var(--color-text-secondary);
          text-decoration: none;
          border-radius: var(--radius-base);
          transition: all var(--duration-fast) var(--ease-standard);
          font-size: var(--font-size-sm);
          font-weight: var(--font-weight-medium);
        }
        
        .navbar__link:hover {
          background-color: var(--color-secondary);
          color: var(--color-text);
        }
        
        .navbar__link--active {
          background-color: var(--color-primary);
          color: var(--color-btn-primary-text);
        }
        
        .main {
          flex: 1;
          padding: var(--space-24);
        }
        
        .container {
          max-width: 1280px;
          margin: 0 auto;
          width: 100%;
        }
        
        .view {
          display: none;
        }
        
        .view--active {
          display: block;
        }
        
        .dashboard-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
          gap: var(--space-24);
          margin-bottom: var(--space-32);
        }
        
        .main-balance-grid {
          display: grid;
          grid-template-columns: 1fr 1fr 1fr;
          gap: var(--space-24);
          margin-bottom: var(--space-32);
        }
        
        .summary-card {
          text-align: center;
        }
        
        .summary-card__title {
          font-size: var(--font-size-sm);
          color: var(--color-text-secondary);
          margin-bottom: var(--space-8);
        }
        
        .summary-card__value {
          font-size: var(--font-size-3xl);
          font-weight: var(--font-weight-bold);
          margin-bottom: var(--space-4);
        }
        
        .summary-card__value--positive {
          color: var(--color-success);
        }
        
        .summary-card__value--negative {
          color: var(--color-error);
        }
        
        .quick-actions {
          display: flex;
          gap: var(--space-12);
          margin-bottom: var(--space-32);
          flex-wrap: wrap;
        }
        
        .charts-grid {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: var(--space-24);
          margin-bottom: var(--space-32);
        }
        
        .chart-container {
          height: 300px;
          position: relative;
        }
        
        .table-container {
          background-color: var(--color-surface);
          border-radius: var(--radius-lg);
          border: 1px solid var(--color-card-border);
          overflow: hidden;
        }
        
        .table {
          width: 100%;
          border-collapse: collapse;
        }
        
        .table th,
        .table td {
          padding: var(--space-12);
          text-align: left;
          border-bottom: 1px solid var(--color-card-border-inner);
        }
        
        .table th {
          background-color: var(--color-bg-1);
          font-weight: var(--font-weight-semibold);
          font-size: var(--font-size-sm);
          color: var(--color-text);
          cursor: pointer;
          user-select: none;
        }
        
        .table th:hover {
          background-color: var(--color-bg-2);
        }
        
        .table tbody tr:hover {
          background-color: var(--color-bg-1);
        }
        
        .table-actions {
          display: flex;
          gap: var(--space-8);
        }
        
        .modal {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
          z-index: 1000;
          align-items: center;
          justify-content: center;
        }
        
        .modal--active {
          display: flex;
        }
        
        .modal__content {
          background-color: var(--color-surface);
          border-radius: var(--radius-lg);
          padding: var(--space-24);
          max-width: 500px;
          width: 90%;
          max-height: 80vh;
          overflow-y: auto;
        }
        
        .modal__header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: var(--space-24);
        }
        
        .modal__title {
          font-size: var(--font-size-xl);
          margin: 0;
        }
        
        .close-btn {
          background: none;
          border: none;
          font-size: var(--font-size-xl);
          cursor: pointer;
          color: var(--color-text-secondary);
          padding: var(--space-4);
          line-height: 1;
        }
        
        .form-row {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: var(--space-16);
          margin-bottom: var(--space-16);
        }
        
        .form-group {
          margin-bottom: var(--space-16);
        }
        
        .warning-banner {
          background-color: var(--color-bg-6);
          border: 1px solid var(--color-warning);
          border-radius: var(--radius-base);
          padding: var(--space-16);
          margin-bottom: var(--space-24);
          color: var(--color-text);
        }
        
        .warning-banner__title {
          font-weight: var(--font-weight-bold);
          color: var(--color-warning);
          margin-bottom: var(--space-8);
        }
        
        .toast {
          position: fixed;
          top: var(--space-24);
          right: var(--space-24);
          background-color: var(--color-surface);
          border-radius: var(--radius-base);
          padding: var(--space-16);
          box-shadow: var(--shadow-lg);
          z-index: 1100;
          transform: translateX(100%);
          transition: transform var(--duration-normal) var(--ease-standard);
        }
        
        .toast--show {
          transform: translateX(0);
        }
        
        .toast--success {
          border-left: 4px solid var(--color-success);
        }
        
        .toast--error {
          border-left: 4px solid var(--color-error);
        }
        
        .amount--positive {
          color: var(--color-success);
        }
        
        .amount--negative {
          color: var(--color-error);
        }
        
        .editable-cell {
          cursor: pointer;
        }
        
        .editable-cell:hover {
          background-color: var(--color-bg-2);
        }
        
        .editable-cell--editing {
          padding: 0;
        }
        
        .editable-cell--editing input,
        .editable-cell--editing select {
          width: 100%;
          border: none;
          padding: var(--space-12);
          background: transparent;
          font-size: inherit;
          color: inherit;
        }
        
        .editable-cell--editing input:focus,
        .editable-cell--editing select:focus {
          outline: 2px solid var(--color-primary);
        }
        
        /* Tipo badges */
        .tipo-badge {
          display: inline-flex;
          align-items: center;
          padding: var(--space-4) var(--space-8);
          border-radius: var(--radius-full);
          font-weight: var(--font-weight-medium);
          font-size: var(--font-size-xs);
        }
        
        .tipo-badge--personal-sonia {
          background-color: #dbeafe;
          color: #1e40af;
          border: 1px solid #93c5fd;
        }
        
        .tipo-badge--personal-stefano {
          background-color: #d1fae5;
          color: #065f46;
          border: 1px solid #6ee7b7;
        }
        
        .tipo-badge--company {
          background-color: #e9d5ff;
          color: #6b21a8;
          border: 1px solid #c4b5fd;
        }
        
        @media (prefers-color-scheme: dark) {
          .tipo-badge--personal-sonia {
            background-color: rgba(59, 130, 246, 0.15);
            color: #93c5fd;
            border: 1px solid rgba(59, 130, 246, 0.3);
          }
          
          .tipo-badge--personal-stefano {
            background-color: rgba(34, 197, 94, 0.15);
            color: #6ee7b7;
            border: 1px solid rgba(34, 197, 94, 0.3);
          }
          
          .tipo-badge--company {
            background-color: rgba(147, 51, 234, 0.15);
            color: #c4b5fd;
            border: 1px solid rgba(147, 51, 234, 0.3);
          }
        }
        
        /* Balance cards layout */
        .balance-cards-container {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: var(--space-24);
          margin: var(--space-20) 0;
        }
        
        .balance-card-column {
          display: flex;
          flex-direction: column;
          gap: var(--space-20);
        }
        
        .balance-card {
          background: var(--color-surface);
          border: 1px solid var(--color-card-border);
          border-radius: var(--radius-lg);
          padding: var(--space-20);
          box-shadow: var(--shadow-sm);
        }
        
        .summary-grid {
          display: flex;
          flex-direction: column;
          gap: var(--space-12);
          margin: var(--space-16) 0;
        }
        
        .summary-row {
          display: grid;
          grid-template-columns: 1fr auto auto;
          gap: var(--space-8);
          align-items: center;
          padding: var(--space-8);
          border-radius: var(--radius-sm);
          background: var(--color-bg-2);
        }
        
        .summary-row.total-row {
          background: var(--color-bg-3);
          border: 2px solid var(--color-success);
          font-weight: var(--font-weight-bold);
        }
        
        .summary-row .label {
          font-size: var(--font-size-sm);
          color: var(--color-text-secondary);
        }
        
        .summary-row .value {
          font-weight: var(--font-weight-bold);
          text-align: right;
        }
        
        .summary-row .value.large {
          font-size: var(--font-size-lg);
        }
        
        .summary-row .detail {
          font-size: var(--font-size-xs);
          color: var(--color-text-secondary);
          text-align: right;
        }
        
        /* Client card improvements */
        .client-card {
          transition: all var(--duration-fast) var(--ease-standard);
          cursor: pointer;
        }
        
        .client-card:hover {
          transform: translateY(-2px);
          box-shadow: var(--shadow-lg);
        }
        
        .card-section {
          margin: var(--space-12) 0;
          padding: var(--space-12);
          border-radius: var(--radius-sm);
          background: var(--color-bg-1);
        }
        
        .card-section.company-section {
          border-left: 3px solid #a855f7;
        }
        
        .card-section.personal-sonia-section {
          border-left: 3px solid #3b82f6;
        }
        
        .card-section.personal-stefano-section {
          border-left: 3px solid #10b981;
        }
        
        .section-header {
          font-size: var(--font-size-xs);
          font-weight: var(--font-weight-bold);
          color: var(--color-text-secondary);
          text-transform: uppercase;
          margin-bottom: var(--space-8);
          letter-spacing: 0.5px;
        }
        
        .transaction-details {
          font-size: var(--font-size-sm);
        }
        
        .detail-row {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin: var(--space-4) 0;
        }
        
        .detail-row .count {
          font-size: var(--font-size-xs);
          color: var(--color-text-secondary);
          margin-left: var(--space-4);
        }
        
        .detail-row.balance-row {
          border-top: 1px solid var(--color-border);
          padding-top: var(--space-6);
          margin-top: var(--space-6);
          font-weight: var(--font-weight-semibold);
        }
        
        .expense-value {
          color: var(--color-error);
        }
        
        .income-value {
          color: var(--color-success);
        }
        
        .check {
          color: var(--color-success);
          margin-left: var(--space-4);
          font-size: var(--font-size-base);
        }
        
        .card-activity-footer {
          display: flex;
          align-items: center;
          gap: var(--space-8);
          margin-top: var(--space-12);
          padding-top: var(--space-12);
          border-top: 1px solid var(--color-border);
          font-size: var(--font-size-xs);
          color: var(--color-text-secondary);
        }
        
        .separator {
          color: var(--color-text-secondary);
        }
        
        .card-total {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin: var(--space-12) 0;
          padding: var(--space-12);
          background: var(--color-bg-3);
          border-radius: var(--radius-sm);
          font-weight: var(--font-weight-semibold);
        }
        
        .card-total .value {
          font-size: var(--font-size-lg);
        }
        
        .no-transactions-message {
          text-align: center;
          padding: var(--space-24);
          color: var(--color-text-secondary);
          font-style: italic;
        }
        
        .person-badge {
          padding: var(--space-4) var(--space-8);
          border-radius: var(--radius-sm);
          font-size: var(--font-size-xs);
          font-weight: var(--font-weight-semibold);
        }
        
        .person-badge.sonia {
          background: #dbeafe;
          color: #1e40af;
        }
        
        .person-badge.stefano {
          background: #d1fae5;
          color: #065f46;
        }
        
        /* Responsive: stack on mobile */
        @media (max-width: 768px) {
          .balance-cards-container {
            grid-template-columns: 1fr;
          }
        }
        
        /* Status badges for client activity */
        .status-badge {
          padding: var(--space-4) var(--space-8);
          border-radius: var(--radius-full);
          font-size: var(--font-size-xs);
          font-weight: var(--font-weight-medium);
          display: inline-flex;
          align-items: center;
          gap: var(--space-4);
        }
        
        .status-badge--balanced {
          background: #d1fae5;
          color: #065f46;
          border: 1px solid #6ee7b7;
        }
        
        .status-badge--active {
          background: #dbeafe;
          color: #1e40af;
          border: 1px solid #93c5fd;
        }
        
        .status-badge--inactive {
          background: #f3f4f6;
          color: #6b7280;
          border: 1px solid #d1d5db;
        }
        
        /* Activity indicators */
        .activity-info {
          display: flex;
          justify-content: space-between;
          align-items: center;
          font-size: var(--font-size-xs);
          color: var(--color-text-secondary);
          background: var(--color-bg-1);
          padding: var(--space-8);
          border-radius: var(--radius-sm);
          margin-top: var(--space-12);
        }
        
        /* Transaction breakdown */
        .transaction-breakdown {
          display: flex;
          justify-content: space-between;
          font-size: var(--font-size-xs);
          margin: var(--space-4) 0;
        }
        
        .transaction-breakdown .expense {
          color: var(--color-error);
        }
        
        .transaction-breakdown .income {
          color: var(--color-success);
        }
        
        .balance-checkmark {
          color: var(--color-success);
          font-weight: var(--font-weight-bold);
          margin-left: var(--space-4);
        }
        
        .clients-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
          gap: var(--space-24);
          padding: 0;
        }
        
        .client-card-header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: var(--space-16);
        }
        
        .client-name {
          font-size: var(--font-size-xl);
          font-weight: var(--font-weight-bold);
          color: var(--color-text);
          margin: 0;
        }
        
        .client-tipo-badge {
          padding: var(--space-4) var(--space-8);
          border-radius: var(--radius-full);
          font-size: var(--font-size-xs);
          font-weight: var(--font-weight-medium);
          white-space: nowrap;
        }
        
        .client-balance {
          font-size: var(--font-size-2xl);
          font-weight: var(--font-weight-bold);
          margin: var(--space-16) 0;
        }
        
        .client-balance--positive {
          color: var(--color-success);
        }
        
        .client-balance--negative {
          color: var(--color-error);
        }
        
        .client-stats {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: var(--space-16);
          margin: var(--space-16) 0;
          padding-top: var(--space-16);
          border-top: 1px solid var(--color-border);
        }
        
        .client-stat {
          text-align: center;
        }
        
        .client-stat-label {
          font-size: var(--font-size-xs);
          color: var(--color-text-secondary);
          margin-bottom: var(--space-4);
        }
        
        .client-stat-value {
          font-size: var(--font-size-lg);
          font-weight: var(--font-weight-semibold);
        }
        
        .client-actions {
          display: flex;
          gap: var(--space-8);
          margin-top: var(--space-16);
        }
        
        .client-actions .btn {
          flex: 1;
        }
        
        .client-actions .btn:not(:first-child) {
          flex: 0 0 auto;
          min-width: 40px;
        }
        
        @media (max-width: 768px) {
          .navbar__nav {
            display: none;
          }
          
          .charts-grid {
            grid-template-columns: 1fr;
          }
          
          .form-row {
            grid-template-columns: 1fr;
          }
          
          .quick-actions {
            flex-direction: column;
          }
          
          .table-container {
            overflow-x: auto;
          }
          
          .balance-cards-container {
            grid-template-columns: 1fr;
          }
          
          .main-balance-grid {
            grid-template-columns: 1fr;
          }
        }
    </style>
</head>
<body>
    <div id="app" class="app">
        <!-- Warning Banner -->
        <div class="warning-banner">
            <div class="warning-banner__title">⚠️ IMPORTANTE</div>
            <div>I dati sono memorizzati solo durante questa sessione. Usa "Esporta Dati" nelle Impostazioni per salvare regolarmente i tuoi dati. <strong>Nota:</strong> Questa applicazione non è collegata a Google Sheets - i clienti e i dati devono essere inseriti manualmente.</div>
        </div>

        <!-- Navigation -->
        <nav class="navbar">
            <div class="navbar__container">
                <a href="file:///C:/Users/faure/OneDrive/Documenti/Lavoro/Wise%20in%20Blue/Gestionale%202026/programma/1/wib-gestionale-github/index.html#" class="navbar__brand">WiB - Wise in Blue</a>
                <ul class="navbar__nav">
                    <li><a href="file:///C:/Users/faure/OneDrive/Documenti/Lavoro/Wise%20in%20Blue/Gestionale%202026/programma/1/wib-gestionale-github/index.html#dashboard" class="navbar__link" data-view="dashboard">Dashboard</a></li>
                    <li><a href="file:///C:/Users/faure/OneDrive/Documenti/Lavoro/Wise%20in%20Blue/Gestionale%202026/programma/1/wib-gestionale-github/index.html#spese" class="navbar__link" data-view="spese">Spese</a></li>
                    <li><a href="file:///C:/Users/faure/OneDrive/Documenti/Lavoro/Wise%20in%20Blue/Gestionale%202026/programma/1/wib-gestionale-github/index.html#entrate" class="navbar__link" data-view="entrate">Entrate</a></li>
                    <li><a href="file:///C:/Users/faure/OneDrive/Documenti/Lavoro/Wise%20in%20Blue/Gestionale%202026/programma/1/wib-gestionale-github/index.html#bonifici" class="navbar__link" data-view="bonifici">Bonifici</a></li>
                    <li><a href="file:///C:/Users/faure/OneDrive/Documenti/Lavoro/Wise%20in%20Blue/Gestionale%202026/programma/1/wib-gestionale-github/index.html#clienti" class="navbar__link navbar__link--active" data-view="clienti">Clienti</a></li>
                    <li><a href="file:///C:/Users/faure/OneDrive/Documenti/Lavoro/Wise%20in%20Blue/Gestionale%202026/programma/1/wib-gestionale-github/index.html#impostazioni" class="navbar__link" data-view="impostazioni">Impostazioni</a></li>
                </ul>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main">
            <div class="container">
                <!-- Dashboard View -->
                <div id="dashboard-view" class="view">
                    <!-- Hero Section - Totale Wise in Blue SOLO SOCIETÀ -->
                    <div class="card" style="background: linear-gradient(135deg, var(--color-primary), var(--color-primary-hover)); color: var(--color-btn-primary-text); margin-bottom: var(--space-32); text-align: center;">
                        <div class="card__body" style="padding: var(--space-32);">
                            <h1 style="font-size: var(--font-size-4xl); margin-bottom: var(--space-16); color: var(--color-btn-primary-text);">WISE IN BLUE</h1>
                            <h2 style="font-size: var(--font-size-2xl); margin-bottom: var(--space-12); color: var(--color-btn-primary-text);">TOTALE GENERALE</h2>
                            <div id="wib-total-balance" style="font-size: 3rem; font-weight: var(--font-weight-bold); color: var(--color-btn-primary-text);" class="summary-card__value--positive">1.105,56&nbsp;€</div>
                            <div style="font-size: var(--font-size-sm); margin-top: var(--space-8); opacity: 0.9; color: var(--color-btn-primary-text);">Solo Società - escluse spese personali</div>
                        </div>
                    </div>
                    
                    <!-- Three Main Balance Sections -->
                    <div class="main-balance-grid">
                        <!-- Società WiB Section -->
                        <div class="card" style="border: 2px solid #9333ea; background: #f3e8ff;">
                            <div class="card__body">
                                <h3 style="color: #7c3aed; margin-bottom: var(--space-16); text-transform: uppercase; font-size: var(--font-size-sm); font-weight: var(--font-weight-bold);">SOCIETÀ WiB</h3>
                                <div id="company-balance" class="summary-card__value summary-card__value--positive" style="margin-bottom: var(--space-16);">1.105,56&nbsp;€</div>
                                <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-8);">Quota Sonia (50%): <span id="sonia-company-share" style="font-weight: var(--font-weight-bold);">552,78&nbsp;€</span></div>
                                <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-16);">Quota Stefano (50%): <span id="stefano-company-share" style="font-weight: var(--font-weight-bold);">552,78&nbsp;€</span></div>
                                <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-8);">Spese Società: <span id="company-expenses-total">744,44&nbsp;€</span></div>
                                <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-16);">Entrate Società: <span id="company-income-total">1.850,00&nbsp;€</span></div>
                                <div style="font-size: var(--font-size-xs); color: var(--color-primary); font-weight: var(--font-weight-medium);">
                                    Situazione: <span id="company-situation">Stefano deve dare a Sonia: 147,22&nbsp;€</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Personale Sonia Section -->
                        <div class="card" style="border: 2px solid #2563eb; background: #eff6ff;">
                            <div class="card__body">
                                <h3 style="color: #2563eb; margin-bottom: var(--space-16); text-transform: uppercase; font-size: var(--font-size-sm); font-weight: var(--font-weight-bold);">PERSONALE SONIA</h3>
                                <div id="personal-sonia-balance" class="summary-card__value summary-card__value--positive" style="margin-bottom: var(--space-16);">330,00&nbsp;€</div>
                                <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-8);">Spese Personali: <span id="personal-sonia-expenses">120,00&nbsp;€</span></div>
                                <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-16);">Entrate Personali: <span id="personal-sonia-income">450,00&nbsp;€</span></div>
                                <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary); font-style: italic;">
                                    (Separato dalla società)
                                </div>
                            </div>
                        </div>
                        
                        <!-- Personale Stefano Section -->
                        <div class="card" style="border: 2px solid #10b981; background: #ecfdf5;">
                            <div class="card__body">
                                <h3 style="color: #10b981; margin-bottom: var(--space-16); text-transform: uppercase; font-size: var(--font-size-sm); font-weight: var(--font-weight-bold);">PERSONALE STEFANO</h3>
                                <div id="personal-stefano-balance" class="summary-card__value summary-card__value--positive" style="margin-bottom: var(--space-16);">250,00&nbsp;€</div>
                                <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-8);">Spese Personali: <span id="personal-stefano-expenses">350,00&nbsp;€</span></div>
                                <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-16);">Entrate Personali: <span id="personal-stefano-income">600,00&nbsp;€</span></div>
                                <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary); font-style: italic;">
                                    (Separato dalla società)
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Summary Statistics -->
                    <div class="dashboard-grid">
                        <div class="card summary-card">
                            <div class="card__body">
                                <div class="summary-card__title">Totale Spese</div>
                                <div id="total-expenses-all-card" class="summary-card__value summary-card__value--negative">1.214,44&nbsp;€</div>
                            </div>
                        </div>
                        <div class="card summary-card">
                            <div class="card__body">
                                <div class="summary-card__title">Totale Entrate</div>
                                <div id="total-income-all-card" class="summary-card__value summary-card__value--positive">2.900,00&nbsp;€</div>
                            </div>
                        </div>
                        <div class="card summary-card">
                            <div class="card__body">
                                <div class="summary-card__title">Numero Clienti Attivi</div>
                                <div id="active-clients-count" class="summary-card__value">10</div>
                            </div>
                        </div>
                        <div class="card summary-card">
                            <div class="card__body">
                                <div class="summary-card__title">Ultimo Aggiornamento</div>
                                <div id="last-update" class="summary-card__value" style="font-size: var(--font-size-sm);">19/10/2025</div>
                            </div>
                        </div>
                    </div>

                    <!-- Riepilogo per Cliente -->
                    <div class="card" style="margin-bottom: var(--space-32);">
                        <div class="card__body">
                            <h3 style="margin-bottom: var(--space-24);">Riepilogo per Cliente</h3>
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Nome Cliente</th>
                                            <th>Saldo Cliente</th>
                                            <th>Spese Totali</th>
                                            <th>Entrate Totali</th>
                                            <th>Situazione</th>
                                            <th>Azioni</th>
                                        </tr>
                                    </thead>
                                    <tbody id="client-summary-table">
            <tr onclick="viewClientDetail(1)" style="cursor: pointer;">
                <td style="font-weight: var(--font-weight-medium);">Villa Maria<br><small style="color: var(--color-text-secondary);">Spese: 414,44&nbsp;€ | Entrate: 800,00&nbsp;€ | 3 transazioni</small></td>
                <td class="amount--positive" style="font-weight: var(--font-weight-bold);">
                    385,56&nbsp;€
                    
                </td>
                <td class="amount--negative">414,44&nbsp;€</td>
                <td class="amount--positive">800,00&nbsp;€</td>
                <td><span style="color: var(--color-success);">Attivo (+)</span></td>
                <td>
                    <button class="btn btn--sm btn--primary" onclick="event.stopPropagation(); viewClientDetail(1)">Apri Scheda</button>
                </td>
            </tr>
        
            <tr onclick="viewClientDetail(2)" style="cursor: pointer;">
                <td style="font-weight: var(--font-weight-medium);">Casa Azzurra<br><small style="color: var(--color-text-secondary);">Spese: 150,00&nbsp;€ | Entrate: 150,00&nbsp;€ | 4 transazioni</small></td>
                <td class="amount--positive" style="font-weight: var(--font-weight-bold);">
                    0,00&nbsp;€
                     ✓
                </td>
                <td class="amount--negative">150,00&nbsp;€</td>
                <td class="amount--positive">150,00&nbsp;€</td>
                <td><span style="color: var(--color-success);">✓ In pari</span></td>
                <td>
                    <button class="btn btn--sm btn--primary" onclick="event.stopPropagation(); viewClientDetail(2)">Apri Scheda</button>
                </td>
            </tr>
        
            <tr onclick="viewClientDetail(3)" style="cursor: pointer;">
                <td style="font-weight: var(--font-weight-medium);">Appartamento Sole<br><small style="color: var(--color-text-secondary);">Spese: 120,00&nbsp;€ | Entrate: 450,00&nbsp;€ | 2 transazioni</small></td>
                <td class="amount--positive" style="font-weight: var(--font-weight-bold);">
                    330,00&nbsp;€
                    
                </td>
                <td class="amount--negative">120,00&nbsp;€</td>
                <td class="amount--positive">450,00&nbsp;€</td>
                <td><span style="color: var(--color-success);">Attivo (+)</span></td>
                <td>
                    <button class="btn btn--sm btn--primary" onclick="event.stopPropagation(); viewClientDetail(3)">Apri Scheda</button>
                </td>
            </tr>
        
            <tr onclick="viewClientDetail(4)" style="cursor: pointer;">
                <td style="font-weight: var(--font-weight-medium);">Villa Vista Mare</td>
                <td class="amount--positive" style="font-weight: var(--font-weight-bold);">
                    0,00&nbsp;€
                    
                </td>
                <td class="">-</td>
                <td class="">-</td>
                <td><span style="color: var(--color-text-secondary);">Nessuna transazione</span></td>
                <td>
                    <button class="btn btn--sm btn--primary" onclick="event.stopPropagation(); viewClientDetail(4)">Apri Scheda</button>
                </td>
            </tr>
        
            <tr onclick="viewClientDetail(5)" style="cursor: pointer;">
                <td style="font-weight: var(--font-weight-medium);">Casa Rosa<br><small style="color: var(--color-text-secondary);">Spese: 350,00&nbsp;€ | Entrate: 600,00&nbsp;€ | 2 transazioni</small></td>
                <td class="amount--positive" style="font-weight: var(--font-weight-bold);">
                    250,00&nbsp;€
                    
                </td>
                <td class="amount--negative">350,00&nbsp;€</td>
                <td class="amount--positive">600,00&nbsp;€</td>
                <td><span style="color: var(--color-success);">Attivo (+)</span></td>
                <td>
                    <button class="btn btn--sm btn--primary" onclick="event.stopPropagation(); viewClientDetail(5)">Apri Scheda</button>
                </td>
            </tr>
        
            <tr onclick="viewClientDetail(6)" style="cursor: pointer;">
                <td style="font-weight: var(--font-weight-medium);">Studio Centro</td>
                <td class="amount--positive" style="font-weight: var(--font-weight-bold);">
                    0,00&nbsp;€
                    
                </td>
                <td class="">-</td>
                <td class="">-</td>
                <td><span style="color: var(--color-text-secondary);">Nessuna transazione</span></td>
                <td>
                    <button class="btn btn--sm btn--primary" onclick="event.stopPropagation(); viewClientDetail(6)">Apri Scheda</button>
                </td>
            </tr>
        
            <tr onclick="viewClientDetail(7)" style="cursor: pointer;">
                <td style="font-weight: var(--font-weight-medium);">Villa Panorama<br><small style="color: var(--color-text-secondary);">Spese: 180,00&nbsp;€ | Entrate: 900,00&nbsp;€ | 2 transazioni</small></td>
                <td class="amount--positive" style="font-weight: var(--font-weight-bold);">
                    720,00&nbsp;€
                    
                </td>
                <td class="amount--negative">180,00&nbsp;€</td>
                <td class="amount--positive">900,00&nbsp;€</td>
                <td><span style="color: var(--color-success);">Attivo (+)</span></td>
                <td>
                    <button class="btn btn--sm btn--primary" onclick="event.stopPropagation(); viewClientDetail(7)">Apri Scheda</button>
                </td>
            </tr>
        
            <tr onclick="viewClientDetail(8)" style="cursor: pointer;">
                <td style="font-weight: var(--font-weight-medium);">Appartamento Luna</td>
                <td class="amount--positive" style="font-weight: var(--font-weight-bold);">
                    0,00&nbsp;€
                    
                </td>
                <td class="">-</td>
                <td class="">-</td>
                <td><span style="color: var(--color-text-secondary);">Nessuna transazione</span></td>
                <td>
                    <button class="btn btn--sm btn--primary" onclick="event.stopPropagation(); viewClientDetail(8)">Apri Scheda</button>
                </td>
            </tr>
        
            <tr onclick="viewClientDetail(9)" style="cursor: pointer;">
                <td style="font-weight: var(--font-weight-medium);">Casa Bianca</td>
                <td class="amount--positive" style="font-weight: var(--font-weight-bold);">
                    0,00&nbsp;€
                    
                </td>
                <td class="">-</td>
                <td class="">-</td>
                <td><span style="color: var(--color-text-secondary);">Nessuna transazione</span></td>
                <td>
                    <button class="btn btn--sm btn--primary" onclick="event.stopPropagation(); viewClientDetail(9)">Apri Scheda</button>
                </td>
            </tr>
        
            <tr onclick="viewClientDetail(10)" style="cursor: pointer;">
                <td style="font-weight: var(--font-weight-medium);">Villa Tramonto</td>
                <td class="amount--positive" style="font-weight: var(--font-weight-bold);">
                    0,00&nbsp;€
                    
                </td>
                <td class="">-</td>
                <td class="">-</td>
                <td><span style="color: var(--color-text-secondary);">Nessuna transazione</span></td>
                <td>
                    <button class="btn btn--sm btn--primary" onclick="event.stopPropagation(); viewClientDetail(10)">Apri Scheda</button>
                </td>
            </tr>
        </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="quick-actions">
                        <button class="btn btn--primary" onclick="showModal(&#39;expense-modal&#39;)">+ Nuova Spesa</button>
                        <button class="btn btn--primary" onclick="showModal(&#39;income-modal&#39;)">+ Nuova Entrata</button>
                        <button class="btn btn--primary" onclick="showModal(&#39;transfer-modal&#39;)">+ Nuovo Bonifico</button>
                        <button class="btn btn--primary" onclick="showModal(&#39;client-modal&#39;)">+ Nuovo Cliente</button>
                    </div>

                    <div class="charts-grid">
                        <div class="card">
                            <div class="card__body">
                                <h3>Spese per Categoria</h3>
                                <div class="chart-container">
                                    <canvas id="expenses-pie-chart" width="594" height="300" style="display: block; box-sizing: border-box; height: 300px; width: 594px;"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card__body">
                                <h3>Confronto Sonia vs Stefano</h3>
                                <div class="chart-container">
                                    <canvas id="comparison-bar-chart" width="594" height="300" style="display: block; box-sizing: border-box; height: 300px; width: 594px;"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Spese View -->
                <div id="spese-view" class="view">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-24);">
                        <h1>Spese</h1>
                        <button class="btn btn--primary" onclick="showModal(&#39;expense-modal&#39;)">+ Aggiungi Spesa</button>
                    </div>
                    
                    <div class="dashboard-grid">
                        <div class="card summary-card">
                            <div class="card__body">
                                <div class="summary-card__title">Spese Personali Sonia</div>
                                <div id="total-expenses-personal-sonia" class="summary-card__value summary-card__value--negative">120,00&nbsp;€</div>
                            </div>
                        </div>
                        <div class="card summary-card">
                            <div class="card__body">
                                <div class="summary-card__title">Spese Personali Stefano</div>
                                <div id="total-expenses-personal-stefano" class="summary-card__value summary-card__value--negative">350,00&nbsp;€</div>
                            </div>
                        </div>
                        <div class="card summary-card">
                            <div class="card__body">
                                <div class="summary-card__title">Spese Società WiB</div>
                                <div id="total-expenses-company" class="summary-card__value summary-card__value--negative">744,44&nbsp;€</div>
                            </div>
                        </div>
                        <div class="card summary-card">
                            <div class="card__body">
                                <div class="summary-card__title">Totale Spese</div>
                                <div id="total-expenses-overall" class="summary-card__value summary-card__value--negative">1.214,44&nbsp;€</div>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th onclick="sortTable(&#39;expenses&#39;, &#39;date&#39;)">Data</th>
                                    <th onclick="sortTable(&#39;expenses&#39;, &#39;client&#39;)">Cliente</th>
                                    <th onclick="sortTable(&#39;expenses&#39;, &#39;description&#39;)">Descrizione</th>
                                    <th onclick="sortTable(&#39;expenses&#39;, &#39;amount&#39;)">Importo</th>
                                    <th onclick="sortTable(&#39;expenses&#39;, &#39;tipo&#39;)">Tipo</th>
                                    <th onclick="sortTable(&#39;expenses&#39;, &#39;paidBy&#39;)">Pagato da</th>
                                    <th onclick="sortTable(&#39;expenses&#39;, &#39;category&#39;)">Categoria</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="expenses-table-body">
                    <tr>
                        <td class="editable-cell" data-field="date" data-id="1" onclick="startEdit(this)">15/10/2025</td>
                        <td>Villa Maria</td>
                        <td class="editable-cell" data-field="description" data-id="1" onclick="startEdit(this)">Vodafone Internet</td>
                        <td class="amount--negative">-214,44&nbsp;€</td>
                        <td><span class="tipo-badge tipo-badge--company">Società WiB</span></td>
                        <td>Sonia</td>
                        <td class="editable-cell" data-field="category" data-id="1" onclick="startEdit(this)">Utilities</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn--sm btn--secondary" onclick="deleteItem(&#39;expenses&#39;, 1)">Elimina</button>
                            </div>
                        </td>
                    </tr>
                
                    <tr>
                        <td class="editable-cell" data-field="date" data-id="2" onclick="startEdit(this)">14/10/2025</td>
                        <td>Casa Rosa</td>
                        <td class="editable-cell" data-field="description" data-id="2" onclick="startEdit(this)">Riparazione caldaia</td>
                        <td class="amount--negative">-350,00&nbsp;€</td>
                        <td><span class="tipo-badge tipo-badge--personal-stefano">Personale - Stefano</span></td>
                        <td>Stefano</td>
                        <td class="editable-cell" data-field="category" data-id="2" onclick="startEdit(this)">Manutenzione</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn--sm btn--secondary" onclick="deleteItem(&#39;expenses&#39;, 2)">Elimina</button>
                            </div>
                        </td>
                    </tr>
                
                    <tr>
                        <td class="editable-cell" data-field="date" data-id="3" onclick="startEdit(this)">13/10/2025</td>
                        <td>Appartamento Sole</td>
                        <td class="editable-cell" data-field="description" data-id="3" onclick="startEdit(this)">Pulizie straordinarie</td>
                        <td class="amount--negative">-120,00&nbsp;€</td>
                        <td><span class="tipo-badge tipo-badge--personal-sonia">Personale - Sonia</span></td>
                        <td>Sonia</td>
                        <td class="editable-cell" data-field="category" data-id="3" onclick="startEdit(this)">Pulizie</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn--sm btn--secondary" onclick="deleteItem(&#39;expenses&#39;, 3)">Elimina</button>
                            </div>
                        </td>
                    </tr>
                
                    <tr>
                        <td class="editable-cell" data-field="date" data-id="4" onclick="startEdit(this)">12/10/2025</td>
                        <td>Villa Maria</td>
                        <td class="editable-cell" data-field="description" data-id="4" onclick="startEdit(this)">Set biancheria</td>
                        <td class="amount--negative">-200,00&nbsp;€</td>
                        <td><span class="tipo-badge tipo-badge--company">Società WiB</span></td>
                        <td>Stefano</td>
                        <td class="editable-cell" data-field="category" data-id="4" onclick="startEdit(this)">Biancheria</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn--sm btn--secondary" onclick="deleteItem(&#39;expenses&#39;, 4)">Elimina</button>
                            </div>
                        </td>
                    </tr>
                
                    <tr>
                        <td class="editable-cell" data-field="date" data-id="5" onclick="startEdit(this)">11/10/2025</td>
                        <td>Villa Panorama</td>
                        <td class="editable-cell" data-field="description" data-id="5" onclick="startEdit(this)">Manutenzione piscina</td>
                        <td class="amount--negative">-180,00&nbsp;€</td>
                        <td><span class="tipo-badge tipo-badge--company">Società WiB</span></td>
                        <td>Sonia</td>
                        <td class="editable-cell" data-field="category" data-id="5" onclick="startEdit(this)">Manutenzione</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn--sm btn--secondary" onclick="deleteItem(&#39;expenses&#39;, 5)">Elimina</button>
                            </div>
                        </td>
                    </tr>
                
                    <tr>
                        <td class="editable-cell" data-field="date" data-id="6" onclick="startEdit(this)">18/10/2025</td>
                        <td>Casa Azzurra</td>
                        <td class="editable-cell" data-field="description" data-id="6" onclick="startEdit(this)">Pulizie extra</td>
                        <td class="amount--negative">-75,00&nbsp;€</td>
                        <td><span class="tipo-badge tipo-badge--company">Società WiB</span></td>
                        <td>Sonia</td>
                        <td class="editable-cell" data-field="category" data-id="6" onclick="startEdit(this)">Pulizie</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn--sm btn--secondary" onclick="deleteItem(&#39;expenses&#39;, 6)">Elimina</button>
                            </div>
                        </td>
                    </tr>
                
                    <tr>
                        <td class="editable-cell" data-field="date" data-id="7" onclick="startEdit(this)">17/10/2025</td>
                        <td>Casa Azzurra</td>
                        <td class="editable-cell" data-field="description" data-id="7" onclick="startEdit(this)">Riparazione rubinetto</td>
                        <td class="amount--negative">-75,00&nbsp;€</td>
                        <td><span class="tipo-badge tipo-badge--company">Società WiB</span></td>
                        <td>Stefano</td>
                        <td class="editable-cell" data-field="category" data-id="7" onclick="startEdit(this)">Manutenzione</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn--sm btn--secondary" onclick="deleteItem(&#39;expenses&#39;, 7)">Elimina</button>
                            </div>
                        </td>
                    </tr>
                </tbody>
                        </table>
                    </div>
                </div>

                <!-- Entrate View -->
                <div id="entrate-view" class="view">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-24);">
                        <h1>Entrate</h1>
                        <button class="btn btn--primary" onclick="showModal(&#39;income-modal&#39;)">+ Aggiungi Entrata</button>
                    </div>
                    
                    <div class="dashboard-grid">
                        <div class="card summary-card">
                            <div class="card__body">
                                <div class="summary-card__title">Entrate Personali Sonia</div>
                                <div id="total-income-personal-sonia" class="summary-card__value summary-card__value--positive">450,00&nbsp;€</div>
                            </div>
                        </div>
                        <div class="card summary-card">
                            <div class="card__body">
                                <div class="summary-card__title">Entrate Personali Stefano</div>
                                <div id="total-income-personal-stefano" class="summary-card__value summary-card__value--positive">600,00&nbsp;€</div>
                            </div>
                        </div>
                        <div class="card summary-card">
                            <div class="card__body">
                                <div class="summary-card__title">Entrate Società WiB</div>
                                <div id="total-income-company" class="summary-card__value summary-card__value--positive">1.850,00&nbsp;€</div>
                            </div>
                        </div>
                        <div class="card summary-card">
                            <div class="card__body">
                                <div class="summary-card__title">Totale Entrate</div>
                                <div id="total-income-overall" class="summary-card__value summary-card__value--positive">2.900,00&nbsp;€</div>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th onclick="sortTable(&#39;income&#39;, &#39;date&#39;)">Data</th>
                                    <th onclick="sortTable(&#39;income&#39;, &#39;client&#39;)">Cliente</th>
                                    <th onclick="sortTable(&#39;income&#39;, &#39;description&#39;)">Descrizione</th>
                                    <th onclick="sortTable(&#39;income&#39;, &#39;amount&#39;)">Importo</th>
                                    <th onclick="sortTable(&#39;income&#39;, &#39;tipo&#39;)">Tipo</th>
                                    <th onclick="sortTable(&#39;income&#39;, &#39;receivedBy&#39;)">Ricevuto da</th>
                                    <th onclick="sortTable(&#39;income&#39;, &#39;category&#39;)">Categoria</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="income-table-body">
                    <tr>
                        <td class="editable-cell" data-field="date" data-id="1" onclick="startEdit(this)">01/10/2025</td>
                        <td>Villa Maria</td>
                        <td class="editable-cell" data-field="description" data-id="1" onclick="startEdit(this)">Affitto Ottobre</td>
                        <td class="amount--positive">800,00&nbsp;€</td>
                        <td><span class="tipo-badge tipo-badge--company">Società WiB</span></td>
                        <td>Sonia</td>
                        <td class="editable-cell" data-field="category" data-id="1" onclick="startEdit(this)">Affitto</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn--sm btn--secondary" onclick="deleteItem(&#39;income&#39;, 1)">Elimina</button>
                            </div>
                        </td>
                    </tr>
                
                    <tr>
                        <td class="editable-cell" data-field="date" data-id="2" onclick="startEdit(this)">02/10/2025</td>
                        <td>Casa Rosa</td>
                        <td class="editable-cell" data-field="description" data-id="2" onclick="startEdit(this)">Affitto Ottobre</td>
                        <td class="amount--positive">600,00&nbsp;€</td>
                        <td><span class="tipo-badge tipo-badge--personal-stefano">Personale - Stefano</span></td>
                        <td>Stefano</td>
                        <td class="editable-cell" data-field="category" data-id="2" onclick="startEdit(this)">Affitto</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn--sm btn--secondary" onclick="deleteItem(&#39;income&#39;, 2)">Elimina</button>
                            </div>
                        </td>
                    </tr>
                
                    <tr>
                        <td class="editable-cell" data-field="date" data-id="3" onclick="startEdit(this)">03/10/2025</td>
                        <td>Appartamento Sole</td>
                        <td class="editable-cell" data-field="description" data-id="3" onclick="startEdit(this)">Affitto Ottobre</td>
                        <td class="amount--positive">450,00&nbsp;€</td>
                        <td><span class="tipo-badge tipo-badge--personal-sonia">Personale - Sonia</span></td>
                        <td>Sonia</td>
                        <td class="editable-cell" data-field="category" data-id="3" onclick="startEdit(this)">Affitto</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn--sm btn--secondary" onclick="deleteItem(&#39;income&#39;, 3)">Elimina</button>
                            </div>
                        </td>
                    </tr>
                
                    <tr>
                        <td class="editable-cell" data-field="date" data-id="4" onclick="startEdit(this)">04/10/2025</td>
                        <td>Villa Panorama</td>
                        <td class="editable-cell" data-field="description" data-id="4" onclick="startEdit(this)">Affitto Ottobre</td>
                        <td class="amount--positive">900,00&nbsp;€</td>
                        <td><span class="tipo-badge tipo-badge--company">Società WiB</span></td>
                        <td>Stefano</td>
                        <td class="editable-cell" data-field="category" data-id="4" onclick="startEdit(this)">Affitto</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn--sm btn--secondary" onclick="deleteItem(&#39;income&#39;, 4)">Elimina</button>
                            </div>
                        </td>
                    </tr>
                
                    <tr>
                        <td class="editable-cell" data-field="date" data-id="5" onclick="startEdit(this)">19/10/2025</td>
                        <td>Casa Azzurra</td>
                        <td class="editable-cell" data-field="description" data-id="5" onclick="startEdit(this)">Pagamento servizi extra</td>
                        <td class="amount--positive">75,00&nbsp;€</td>
                        <td><span class="tipo-badge tipo-badge--company">Società WiB</span></td>
                        <td>Sonia</td>
                        <td class="editable-cell" data-field="category" data-id="5" onclick="startEdit(this)">Servizi Extra</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn--sm btn--secondary" onclick="deleteItem(&#39;income&#39;, 5)">Elimina</button>
                            </div>
                        </td>
                    </tr>
                
                    <tr>
                        <td class="editable-cell" data-field="date" data-id="6" onclick="startEdit(this)">16/10/2025</td>
                        <td>Casa Azzurra</td>
                        <td class="editable-cell" data-field="description" data-id="6" onclick="startEdit(this)">Rimborso danni</td>
                        <td class="amount--positive">75,00&nbsp;€</td>
                        <td><span class="tipo-badge tipo-badge--company">Società WiB</span></td>
                        <td>Stefano</td>
                        <td class="editable-cell" data-field="category" data-id="6" onclick="startEdit(this)">Danni Ospiti</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn--sm btn--secondary" onclick="deleteItem(&#39;income&#39;, 6)">Elimina</button>
                            </div>
                        </td>
                    </tr>
                </tbody>
                        </table>
                    </div>
                </div>

                <!-- Bonifici View -->
                <div id="bonifici-view" class="view">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-24);">
                        <h1>Bonifici</h1>
                        <button class="btn btn--primary" onclick="showModal(&#39;transfer-modal&#39;)">+ Aggiungi Bonifico</button>
                    </div>
                    
                    <div class="dashboard-grid">
                        <div class="card summary-card">
                            <div class="card__body">
                                <div class="summary-card__title">Trasferimenti Sonia → Stefano</div>
                                <div id="transfers-sonia-to-stefano" class="summary-card__value">0,00&nbsp;€</div>
                            </div>
                        </div>
                        <div class="card summary-card">
                            <div class="card__body">
                                <div class="summary-card__title">Trasferimenti Stefano → Sonia</div>
                                <div id="transfers-stefano-to-sonia" class="summary-card__value">1.000,00&nbsp;€</div>
                            </div>
                        </div>
                        <div class="card summary-card">
                            <div class="card__body">
                                <div class="summary-card__title">Trasferimenti Netti</div>
                                <div id="net-transfers" class="summary-card__value">1.000,00&nbsp;€</div>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th onclick="sortTable(&#39;transfers&#39;, &#39;date&#39;)">Data</th>
                                    <th onclick="sortTable(&#39;transfers&#39;, &#39;description&#39;)">Descrizione</th>
                                    <th onclick="sortTable(&#39;transfers&#39;, &#39;from&#39;)">Da</th>
                                    <th onclick="sortTable(&#39;transfers&#39;, &#39;to&#39;)">A</th>
                                    <th onclick="sortTable(&#39;transfers&#39;, &#39;amount&#39;)">Importo</th>
                                    <th onclick="sortTable(&#39;transfers&#39;, &#39;status&#39;)">Stato</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="transfers-table-body">
                    <tr>
                        <td class="editable-cell" data-field="date" data-id="1" onclick="startEdit(this)">16/10/2025</td>
                        <td class="editable-cell" data-field="description" data-id="1" onclick="startEdit(this)">Bonifico da Ste a Sonia - spese società</td>
                        <td>Stefano</td>
                        <td>Sonia</td>
                        <td class="amount--positive">1.000,00&nbsp;€</td>
                        <td><span class="status status--success">Completato</span></td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn--sm btn--secondary" onclick="deleteItem(&#39;transfers&#39;, 1)">Elimina</button>
                            </div>
                        </td>
                    </tr>
                </tbody>
                        </table>
                    </div>
                </div>

                <!-- Clienti View -->
                <div id="clienti-view" class="view">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-24);">
                        <h1>Clienti</h1>
                        <button class="btn btn--primary" onclick="showModal(&#39;client-modal&#39;)">+ Aggiungi Cliente</button>
                    </div>
                    
                    <div id="clients-list" class="clients-grid">
                <div class="card client-card" style="cursor: pointer; transition: transform 0.2s ease;" onmouseover="this.style.transform=&#39;translateY(-2px)&#39;" onmouseout="this.style.transform=&#39;translateY(0)&#39;" onclick="viewClientDetail(1)">
                    <div class="card__body">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-16);">
                            <h3 style="margin: 0; color: var(--color-text);">Villa Maria</h3>
                            <div style="background: #e9d5ff; padding: var(--space-4) var(--space-8); border-radius: var(--radius-full); font-size: var(--font-size-xs); font-weight: var(--font-weight-medium);">
                                Società WiB
                            </div>
                        </div>
                        
                        
                    <div style="border-left: 3px solid #9333ea; padding-left: var(--space-12); margin-bottom: var(--space-12);">
                        <div style="font-size: var(--font-size-xs); color: #7c3aed; font-weight: var(--font-weight-bold); text-transform: uppercase; margin-bottom: var(--space-4);">SOCIETÀ WiB</div>
                        <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-success)">385,56&nbsp;€</div>
                        <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">Spese: 414,44&nbsp;€ | Entrate: 800,00&nbsp;€</div>
                    </div>
                
                        
                        <div style="border-top: 1px solid var(--color-border); padding-top: var(--space-12); margin-top: var(--space-16);">
                            <div style="display: flex; justify-content: between; align-items: center;">
                                <strong>TOTALE CLIENTE:</strong>
                                <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-success)">
                                    385,56&nbsp;€
                                </div>
                            </div>
                        </div>
                        
                        <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-top: var(--space-12);">Zakynthos, Kalamaki</div>
                        
                        <div style="display: flex; gap: var(--space-8); margin-top: var(--space-16);">
                            <button class="btn btn--sm btn--primary" onclick="event.stopPropagation(); viewClientDetail(1)" style="flex: 1;">
                                Apri Scheda
                            </button>
                            <button class="btn btn--sm btn--secondary" onclick="event.stopPropagation(); editClient(1)" title="Modifica">
                                ✏️
                            </button>
                            <button class="btn btn--sm btn--secondary" onclick="event.stopPropagation(); deleteClient(1)" title="Elimina">
                                🗑️
                            </button>
                        </div>
                    </div>
                </div>
            
                <div class="card client-card" style="cursor: pointer; transition: transform 0.2s; transform: translateY(0px);" onmouseover="this.style.transform=&#39;translateY(-2px)&#39;" onmouseout="this.style.transform=&#39;translateY(0)&#39;" onclick="viewClientDetail(2)">
                    <div class="card__body">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-16);">
                            <h3 style="margin: 0; color: var(--color-text);">Casa Azzurra</h3>
                            <div style="background: #e9d5ff; padding: var(--space-4) var(--space-8); border-radius: var(--radius-full); font-size: var(--font-size-xs); font-weight: var(--font-weight-medium);">
                                Società WiB
                            </div>
                        </div>
                        
                        <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); text-align: center; padding: var(--space-16);">Nessuna transazione</div>
                        
                        <div style="border-top: 1px solid var(--color-border); padding-top: var(--space-12); margin-top: var(--space-16);">
                            <div style="display: flex; justify-content: between; align-items: center;">
                                <strong>TOTALE CLIENTE:</strong>
                                <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-success)">
                                    0,00&nbsp;€
                                </div>
                            </div>
                        </div>
                        
                        <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-top: var(--space-12);">Zakynthos, Argassi</div>
                        
                        <div style="display: flex; gap: var(--space-8); margin-top: var(--space-16);">
                            <button class="btn btn--sm btn--primary" onclick="event.stopPropagation(); viewClientDetail(2)" style="flex: 1;">
                                Apri Scheda
                            </button>
                            <button class="btn btn--sm btn--secondary" onclick="event.stopPropagation(); editClient(2)" title="Modifica">
                                ✏️
                            </button>
                            <button class="btn btn--sm btn--secondary" onclick="event.stopPropagation(); deleteClient(2)" title="Elimina">
                                🗑️
                            </button>
                        </div>
                    </div>
                </div>
            
                <div class="card client-card" style="cursor: pointer; transition: transform 0.2s; transform: translateY(0px);" onmouseover="this.style.transform=&#39;translateY(-2px)&#39;" onmouseout="this.style.transform=&#39;translateY(0)&#39;" onclick="viewClientDetail(3)">
                    <div class="card__body">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-16);">
                            <h3 style="margin: 0; color: var(--color-text);">Appartamento Sole</h3>
                            <div style="background: #dbeafe; padding: var(--space-4) var(--space-8); border-radius: var(--radius-full); font-size: var(--font-size-xs); font-weight: var(--font-weight-medium);">
                                Personale Sonia
                            </div>
                        </div>
                        
                        
                    <div style="border-left: 3px solid #2563eb; padding-left: var(--space-12); margin-bottom: var(--space-12);">
                        <div style="font-size: var(--font-size-xs); color: #2563eb; font-weight: var(--font-weight-bold); text-transform: uppercase; margin-bottom: var(--space-4);">PERSONALE SONIA</div>
                        <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-success)">330,00&nbsp;€</div>
                    </div>
                
                        
                        <div style="border-top: 1px solid var(--color-border); padding-top: var(--space-12); margin-top: var(--space-16);">
                            <div style="display: flex; justify-content: between; align-items: center;">
                                <strong>TOTALE CLIENTE:</strong>
                                <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-success)">
                                    330,00&nbsp;€
                                </div>
                            </div>
                        </div>
                        
                        <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-top: var(--space-12);">Zakynthos, Tsilivi</div>
                        
                        <div style="display: flex; gap: var(--space-8); margin-top: var(--space-16);">
                            <button class="btn btn--sm btn--primary" onclick="event.stopPropagation(); viewClientDetail(3)" style="flex: 1;">
                                Apri Scheda
                            </button>
                            <button class="btn btn--sm btn--secondary" onclick="event.stopPropagation(); editClient(3)" title="Modifica">
                                ✏️
                            </button>
                            <button class="btn btn--sm btn--secondary" onclick="event.stopPropagation(); deleteClient(3)" title="Elimina">
                                🗑️
                            </button>
                        </div>
                    </div>
                </div>
            
                <div class="card client-card" style="cursor: pointer; transition: transform 0.2s ease;" onmouseover="this.style.transform=&#39;translateY(-2px)&#39;" onmouseout="this.style.transform=&#39;translateY(0)&#39;" onclick="viewClientDetail(4)">
                    <div class="card__body">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-16);">
                            <h3 style="margin: 0; color: var(--color-text);">Villa Vista Mare</h3>
                            <div style="background: #e9d5ff; padding: var(--space-4) var(--space-8); border-radius: var(--radius-full); font-size: var(--font-size-xs); font-weight: var(--font-weight-medium);">
                                Società WiB
                            </div>
                        </div>
                        
                        <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); text-align: center; padding: var(--space-16);">Nessuna transazione</div>
                        
                        <div style="border-top: 1px solid var(--color-border); padding-top: var(--space-12); margin-top: var(--space-16);">
                            <div style="display: flex; justify-content: between; align-items: center;">
                                <strong>TOTALE CLIENTE:</strong>
                                <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-success)">
                                    0,00&nbsp;€
                                </div>
                            </div>
                        </div>
                        
                        <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-top: var(--space-12);">Zakynthos, Vasilikos</div>
                        
                        <div style="display: flex; gap: var(--space-8); margin-top: var(--space-16);">
                            <button class="btn btn--sm btn--primary" onclick="event.stopPropagation(); viewClientDetail(4)" style="flex: 1;">
                                Apri Scheda
                            </button>
                            <button class="btn btn--sm btn--secondary" onclick="event.stopPropagation(); editClient(4)" title="Modifica">
                                ✏️
                            </button>
                            <button class="btn btn--sm btn--secondary" onclick="event.stopPropagation(); deleteClient(4)" title="Elimina">
                                🗑️
                            </button>
                        </div>
                    </div>
                </div>
            
                <div class="card client-card" style="cursor: pointer; transition: transform 0.2s ease;" onmouseover="this.style.transform=&#39;translateY(-2px)&#39;" onmouseout="this.style.transform=&#39;translateY(0)&#39;" onclick="viewClientDetail(5)">
                    <div class="card__body">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-16);">
                            <h3 style="margin: 0; color: var(--color-text);">Casa Rosa</h3>
                            <div style="background: #d1fae5; padding: var(--space-4) var(--space-8); border-radius: var(--radius-full); font-size: var(--font-size-xs); font-weight: var(--font-weight-medium);">
                                Personale Stefano
                            </div>
                        </div>
                        
                        
                    <div style="border-left: 3px solid #10b981; padding-left: var(--space-12); margin-bottom: var(--space-12);">
                        <div style="font-size: var(--font-size-xs); color: #10b981; font-weight: var(--font-weight-bold); text-transform: uppercase; margin-bottom: var(--space-4);">PERSONALE STEFANO</div>
                        <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-success)">250,00&nbsp;€</div>
                    </div>
                
                        
                        <div style="border-top: 1px solid var(--color-border); padding-top: var(--space-12); margin-top: var(--space-16);">
                            <div style="display: flex; justify-content: between; align-items: center;">
                                <strong>TOTALE CLIENTE:</strong>
                                <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-success)">
                                    250,00&nbsp;€
                                </div>
                            </div>
                        </div>
                        
                        <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-top: var(--space-12);">Zakynthos, Laganas</div>
                        
                        <div style="display: flex; gap: var(--space-8); margin-top: var(--space-16);">
                            <button class="btn btn--sm btn--primary" onclick="event.stopPropagation(); viewClientDetail(5)" style="flex: 1;">
                                Apri Scheda
                            </button>
                            <button class="btn btn--sm btn--secondary" onclick="event.stopPropagation(); editClient(5)" title="Modifica">
                                ✏️
                            </button>
                            <button class="btn btn--sm btn--secondary" onclick="event.stopPropagation(); deleteClient(5)" title="Elimina">
                                🗑️
                            </button>
                        </div>
                    </div>
                </div>
            
                <div class="card client-card" style="cursor: pointer; transition: transform 0.2s ease;" onmouseover="this.style.transform=&#39;translateY(-2px)&#39;" onmouseout="this.style.transform=&#39;translateY(0)&#39;" onclick="viewClientDetail(6)">
                    <div class="card__body">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-16);">
                            <h3 style="margin: 0; color: var(--color-text);">Studio Centro</h3>
                            <div style="background: #dbeafe; padding: var(--space-4) var(--space-8); border-radius: var(--radius-full); font-size: var(--font-size-xs); font-weight: var(--font-weight-medium);">
                                Personale Sonia
                            </div>
                        </div>
                        
                        <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); text-align: center; padding: var(--space-16);">Nessuna transazione</div>
                        
                        <div style="border-top: 1px solid var(--color-border); padding-top: var(--space-12); margin-top: var(--space-16);">
                            <div style="display: flex; justify-content: between; align-items: center;">
                                <strong>TOTALE CLIENTE:</strong>
                                <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-success)">
                                    0,00&nbsp;€
                                </div>
                            </div>
                        </div>
                        
                        <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-top: var(--space-12);">Zakynthos, Centro</div>
                        
                        <div style="display: flex; gap: var(--space-8); margin-top: var(--space-16);">
                            <button class="btn btn--sm btn--primary" onclick="event.stopPropagation(); viewClientDetail(6)" style="flex: 1;">
                                Apri Scheda
                            </button>
                            <button class="btn btn--sm btn--secondary" onclick="event.stopPropagation(); editClient(6)" title="Modifica">
                                ✏️
                            </button>
                            <button class="btn btn--sm btn--secondary" onclick="event.stopPropagation(); deleteClient(6)" title="Elimina">
                                🗑️
                            </button>
                        </div>
                    </div>
                </div>
            
                <div class="card client-card" style="cursor: pointer; transition: transform 0.2s ease;" onmouseover="this.style.transform=&#39;translateY(-2px)&#39;" onmouseout="this.style.transform=&#39;translateY(0)&#39;" onclick="viewClientDetail(7)">
                    <div class="card__body">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-16);">
                            <h3 style="margin: 0; color: var(--color-text);">Villa Panorama</h3>
                            <div style="background: #e9d5ff; padding: var(--space-4) var(--space-8); border-radius: var(--radius-full); font-size: var(--font-size-xs); font-weight: var(--font-weight-medium);">
                                Società WiB
                            </div>
                        </div>
                        
                        
                    <div style="border-left: 3px solid #9333ea; padding-left: var(--space-12); margin-bottom: var(--space-12);">
                        <div style="font-size: var(--font-size-xs); color: #7c3aed; font-weight: var(--font-weight-bold); text-transform: uppercase; margin-bottom: var(--space-4);">SOCIETÀ WiB</div>
                        <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-success)">720,00&nbsp;€</div>
                        <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">Spese: 180,00&nbsp;€ | Entrate: 900,00&nbsp;€</div>
                    </div>
                
                        
                        <div style="border-top: 1px solid var(--color-border); padding-top: var(--space-12); margin-top: var(--space-16);">
                            <div style="display: flex; justify-content: between; align-items: center;">
                                <strong>TOTALE CLIENTE:</strong>
                                <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-success)">
                                    720,00&nbsp;€
                                </div>
                            </div>
                        </div>
                        
                        <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-top: var(--space-12);">Zakynthos, Keri</div>
                        
                        <div style="display: flex; gap: var(--space-8); margin-top: var(--space-16);">
                            <button class="btn btn--sm btn--primary" onclick="event.stopPropagation(); viewClientDetail(7)" style="flex: 1;">
                                Apri Scheda
                            </button>
                            <button class="btn btn--sm btn--secondary" onclick="event.stopPropagation(); editClient(7)" title="Modifica">
                                ✏️
                            </button>
                            <button class="btn btn--sm btn--secondary" onclick="event.stopPropagation(); deleteClient(7)" title="Elimina">
                                🗑️
                            </button>
                        </div>
                    </div>
                </div>
            
                <div class="card client-card" style="cursor: pointer; transition: transform 0.2s ease;" onmouseover="this.style.transform=&#39;translateY(-2px)&#39;" onmouseout="this.style.transform=&#39;translateY(0)&#39;" onclick="viewClientDetail(8)">
                    <div class="card__body">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-16);">
                            <h3 style="margin: 0; color: var(--color-text);">Appartamento Luna</h3>
                            <div style="background: #d1fae5; padding: var(--space-4) var(--space-8); border-radius: var(--radius-full); font-size: var(--font-size-xs); font-weight: var(--font-weight-medium);">
                                Personale Stefano
                            </div>
                        </div>
                        
                        <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); text-align: center; padding: var(--space-16);">Nessuna transazione</div>
                        
                        <div style="border-top: 1px solid var(--color-border); padding-top: var(--space-12); margin-top: var(--space-16);">
                            <div style="display: flex; justify-content: between; align-items: center;">
                                <strong>TOTALE CLIENTE:</strong>
                                <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-success)">
                                    0,00&nbsp;€
                                </div>
                            </div>
                        </div>
                        
                        <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-top: var(--space-12);">Zakynthos, Alykes</div>
                        
                        <div style="display: flex; gap: var(--space-8); margin-top: var(--space-16);">
                            <button class="btn btn--sm btn--primary" onclick="event.stopPropagation(); viewClientDetail(8)" style="flex: 1;">
                                Apri Scheda
                            </button>
                            <button class="btn btn--sm btn--secondary" onclick="event.stopPropagation(); editClient(8)" title="Modifica">
                                ✏️
                            </button>
                            <button class="btn btn--sm btn--secondary" onclick="event.stopPropagation(); deleteClient(8)" title="Elimina">
                                🗑️
                            </button>
                        </div>
                    </div>
                </div>
            
                <div class="card client-card" style="cursor: pointer; transition: transform 0.2s ease;" onmouseover="this.style.transform=&#39;translateY(-2px)&#39;" onmouseout="this.style.transform=&#39;translateY(0)&#39;" onclick="viewClientDetail(9)">
                    <div class="card__body">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-16);">
                            <h3 style="margin: 0; color: var(--color-text);">Casa Bianca</h3>
                            <div style="background: #dbeafe; padding: var(--space-4) var(--space-8); border-radius: var(--radius-full); font-size: var(--font-size-xs); font-weight: var(--font-weight-medium);">
                                Personale Sonia
                            </div>
                        </div>
                        
                        <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); text-align: center; padding: var(--space-16);">Nessuna transazione</div>
                        
                        <div style="border-top: 1px solid var(--color-border); padding-top: var(--space-12); margin-top: var(--space-16);">
                            <div style="display: flex; justify-content: between; align-items: center;">
                                <strong>TOTALE CLIENTE:</strong>
                                <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-success)">
                                    0,00&nbsp;€
                                </div>
                            </div>
                        </div>
                        
                        <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-top: var(--space-12);">Zakynthos, Volimes</div>
                        
                        <div style="display: flex; gap: var(--space-8); margin-top: var(--space-16);">
                            <button class="btn btn--sm btn--primary" onclick="event.stopPropagation(); viewClientDetail(9)" style="flex: 1;">
                                Apri Scheda
                            </button>
                            <button class="btn btn--sm btn--secondary" onclick="event.stopPropagation(); editClient(9)" title="Modifica">
                                ✏️
                            </button>
                            <button class="btn btn--sm btn--secondary" onclick="event.stopPropagation(); deleteClient(9)" title="Elimina">
                                🗑️
                            </button>
                        </div>
                    </div>
                </div>
            
                <div class="card client-card" style="cursor: pointer; transition: transform 0.2s ease;" onmouseover="this.style.transform=&#39;translateY(-2px)&#39;" onmouseout="this.style.transform=&#39;translateY(0)&#39;" onclick="viewClientDetail(10)">
                    <div class="card__body">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-16);">
                            <h3 style="margin: 0; color: var(--color-text);">Villa Tramonto</h3>
                            <div style="background: #d1fae5; padding: var(--space-4) var(--space-8); border-radius: var(--radius-full); font-size: var(--font-size-xs); font-weight: var(--font-weight-medium);">
                                Personale Stefano
                            </div>
                        </div>
                        
                        <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); text-align: center; padding: var(--space-16);">Nessuna transazione</div>
                        
                        <div style="border-top: 1px solid var(--color-border); padding-top: var(--space-12); margin-top: var(--space-16);">
                            <div style="display: flex; justify-content: between; align-items: center;">
                                <strong>TOTALE CLIENTE:</strong>
                                <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-success)">
                                    0,00&nbsp;€
                                </div>
                            </div>
                        </div>
                        
                        <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-top: var(--space-12);">Zakynthos, Porto Koukla</div>
                        
                        <div style="display: flex; gap: var(--space-8); margin-top: var(--space-16);">
                            <button class="btn btn--sm btn--primary" onclick="event.stopPropagation(); viewClientDetail(10)" style="flex: 1;">
                                Apri Scheda
                            </button>
                            <button class="btn btn--sm btn--secondary" onclick="event.stopPropagation(); editClient(10)" title="Modifica">
                                ✏️
                            </button>
                            <button class="btn btn--sm btn--secondary" onclick="event.stopPropagation(); deleteClient(10)" title="Elimina">
                                🗑️
                            </button>
                        </div>
                    </div>
                </div>
            </div>
                </div>

                <!-- Client Detail View -->
                <div id="client-detail-view" class="view view--active">
                    <div style="display: flex; align-items: center; gap: var(--space-16); margin-bottom: var(--space-24);">
                        <button class="btn btn--secondary" onclick="showView(&#39;clienti&#39;); updateActiveNav(&#39;clienti&#39;);">← Torna ai Clienti</button>
                        <div>
                            <h1 id="client-detail-name">Casa Azzurra</h1>
                            <div id="client-detail-info" style="color: var(--color-text-secondary); font-size: var(--font-size-sm);">
        Email: azzurra@wib.com 
        | Tel: +30 123 456 7891
        <br>Indirizzo: Zakynthos, Argassi
    </div>
                        </div>
                    </div>

                    <!-- Balance cards in two columns: left column for cards, right column for activity summary -->
                    <div class="balance-cards-container" style="margin-bottom: var(--space-32);">
                        <div class="balance-card-column left">
                            <!-- Company Section -->
                            <div class="card" style="border: 2px solid rgb(147, 51, 234); background: rgb(243, 232, 255); display: block;" id="client-company-card">
                                <div class="card__body">
                                    <h3 style="color: #7c3aed; margin-bottom: var(--space-16); text-transform: uppercase; font-size: var(--font-size-sm); font-weight: var(--font-weight-bold);">SOCIETÀ WiB</h3>
                                    <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-8);">Cliente: <span id="client-company-name" style="font-weight: var(--font-weight-bold);">Casa Azzurra</span></div>
                                    <div id="client-company-balance" class="summary-card__value" style="margin-bottom: var(--space-16);">0,00&nbsp;€ <span style="color: #10b981; margin-left: 8px;">✓ In pari</span></div>
                                    <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-8);">Spese Società: <span id="client-company-expenses">150,00&nbsp;€</span></div>
                                    <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-16);">Entrate Società: <span id="client-company-income">150,00&nbsp;€</span></div>
                                    <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-8);">Quota Sonia (50%): <span id="client-sonia-company-share">0,00&nbsp;€</span></div>
                                    <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-16);">Quota Stefano (50%): <span id="client-stefano-company-share">0,00&nbsp;€</span></div>
                                    <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-8);">Pagato da Sonia: <span id="client-company-paid-sonia">75,00&nbsp;€</span></div>
                                    <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-8);">Ricevuto da Sonia: <span id="client-company-received-sonia">75,00&nbsp;€</span></div>
                                    <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-8);">→ Contributo netto Sonia: <span id="client-company-net-sonia">0,00&nbsp;€</span></div>
                                    <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-8);">Pagato da Stefano: <span id="client-company-paid-stefano">75,00&nbsp;€</span></div>
                                    <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-8);">Ricevuto da Stefano: <span id="client-company-received-stefano">75,00&nbsp;€</span></div>
                                    <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-16);">→ Contributo netto Stefano: <span id="client-company-net-stefano">0,00&nbsp;€</span></div>
                                    <div style="font-size: var(--font-size-xs); color: var(--color-primary); font-weight: var(--font-weight-medium);">
                                        Situazione: <span id="client-company-situation">In pari ✓</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Personal Sonia Section -->
                            <div class="card" style="border: 2px solid rgb(37, 99, 235); background: rgb(239, 246, 255); display: none;" id="client-sonia-card">
                                <div class="card__body">
                                    <h3 style="color: #2563eb; margin-bottom: var(--space-16); text-transform: uppercase; font-size: var(--font-size-sm); font-weight: var(--font-weight-bold);">PERSONALE SONIA</h3>
                                    <div id="client-personal-sonia-balance" class="summary-card__value" style="margin-bottom: var(--space-16);">€ 0,00</div>
                                    <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-8);">Spese Personali: <span id="client-personal-sonia-expenses">€ 0,00</span></div>
                                    <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-16);">Entrate Personali: <span id="client-personal-sonia-income">€ 0,00</span></div>
                                    <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary); font-style: italic;">
                                        (Non incluso nella società)
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Personal Stefano Section -->
                            <div class="card" style="border: 2px solid rgb(16, 185, 129); background: rgb(236, 253, 245); display: none;" id="client-stefano-card">
                                <div class="card__body">
                                    <h3 style="color: #10b981; margin-bottom: var(--space-16); text-transform: uppercase; font-size: var(--font-size-sm); font-weight: var(--font-weight-bold);">PERSONALE STEFANO</h3>
                                    <div id="client-personal-stefano-balance" class="summary-card__value" style="margin-bottom: var(--space-16);">€ 0,00</div>
                                    <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-8);">Spese Personali: <span id="client-personal-stefano-expenses">€ 0,00</span></div>
                                    <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-16);">Entrate Personali: <span id="client-personal-stefano-income">€ 0,00</span></div>
                                    <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary); font-style: italic;">
                                        (Non incluso nella società)
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="balance-card-column right">
                            <!-- Activity Summary Card (Yellow/Beige) -->
                            <div class="card balance-card summary-card" style="background: #fef3c7; border: 1px solid #fbbf24;">
                                <div class="card__body">
                                    <h3 style="color: #92400e; margin-bottom: var(--space-16); text-transform: uppercase; font-size: var(--font-size-sm); font-weight: var(--font-weight-bold);">RIEPILOGO ATTIVITÀ</h3>
                                    
                                    <!-- Stats Grid -->
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-16); margin-bottom: var(--space-20);">
                                        <div style="background: white; padding: var(--space-16); border-radius: var(--radius-base); text-align: center;">
                                            <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary); text-transform: uppercase; font-weight: var(--font-weight-bold); margin-bottom: var(--space-8);">Transazioni Totali</div>
                                            <div id="client-activity-total-transactions" style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); color: var(--color-text);">4</div>
                                        </div>
                                        
                                        <div style="background: white; padding: var(--space-16); border-radius: var(--radius-base); text-align: center;">
                                            <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary); text-transform: uppercase; font-weight: var(--font-weight-bold); margin-bottom: var(--space-8);">Spese Totali</div>
                                            <div id="client-activity-total-expenses" style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); color: var(--color-error);">150,00&nbsp;€</div>
                                        </div>
                                        
                                        <div style="background: white; padding: var(--space-16); border-radius: var(--radius-base); text-align: center;">
                                            <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary); text-transform: uppercase; font-weight: var(--font-weight-bold); margin-bottom: var(--space-8);">Entrate Totali</div>
                                            <div id="client-activity-total-income" style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); color: var(--color-success);">150,00&nbsp;€</div>
                                        </div>
                                        
                                        <div style="background: white; padding: var(--space-16); border-radius: var(--radius-base); text-align: center;">
                                            <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary); text-transform: uppercase; font-weight: var(--font-weight-bold); margin-bottom: var(--space-8);">Ultima Transazione</div>
                                            <div id="client-activity-last-transaction" style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); color: var(--color-text);">19/10/2025</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Breakdown Section -->
                                    <div style="padding-top: var(--space-16); border-top: 2px solid #f59e0b;">
                                        <h4 style="font-size: var(--font-size-sm); font-weight: var(--font-weight-bold); text-transform: uppercase; color: #92400e; margin-bottom: var(--space-12);">Dettaglio per Tipo</h4>
                                        
                                        <div id="client-activity-company-row" style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-8) var(--space-12); margin: var(--space-6) 0; background: white; border-radius: var(--radius-sm); opacity: 1;">
                                            <span style="font-size: var(--font-size-sm);">Società WiB:</span>
                                            <span id="client-activity-company-amount" style="font-size: var(--font-size-md); font-weight: var(--font-weight-bold);" class="">0,00&nbsp;€</span>
                                            <span id="client-activity-company-count" style="font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-left: var(--space-8);">4 transazioni</span>
                                        </div>
                                        
                                        <div id="client-activity-sonia-row" style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-8) var(--space-12); margin: var(--space-6) 0; background: white; border-radius: var(--radius-sm); opacity: 0.5;">
                                            <span style="font-size: var(--font-size-sm);">Personale Sonia:</span>
                                            <span id="client-activity-sonia-amount" style="font-size: var(--font-size-md); font-weight: var(--font-weight-bold);" class="">0,00&nbsp;€</span>
                                            <span id="client-activity-sonia-count" style="font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-left: var(--space-8);">0 transazioni</span>
                                        </div>
                                        
                                        <div id="client-activity-stefano-row" style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-8) var(--space-12); margin: var(--space-6) 0; background: white; border-radius: var(--radius-sm); opacity: 0.5;">
                                            <span style="font-size: var(--font-size-sm);">Personale Stefano:</span>
                                            <span id="client-activity-stefano-amount" style="font-size: var(--font-size-md); font-weight: var(--font-weight-bold);" class="">0,00&nbsp;€</span>
                                            <span id="client-activity-stefano-count" style="font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-left: var(--space-8);">0 transazioni</span>
                                        </div>
                                        
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-8) var(--space-12); margin: var(--space-12) 0; background: #fed7aa; border: 2px solid #f59e0b; border-radius: var(--radius-sm); font-weight: var(--font-weight-bold);">
                                            <span style="font-size: var(--font-size-sm);"><strong>TOTALE CLIENTE:</strong></span>
                                            <span id="client-activity-total-amount" style="font-size: var(--font-size-md); font-weight: var(--font-weight-bold);" class="">0,00&nbsp;€ <span style="color: #10b981;">✓</span></span>
                                            <span id="client-activity-total-count" style="font-size: var(--font-size-xs); margin-left: var(--space-8);">Totale: 4</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Client Tabs -->
                    <div style="border-bottom: 1px solid var(--color-border); margin-bottom: var(--space-24);">
                        <div style="display: flex; gap: var(--space-4);">
                            <button class="btn btn--secondary client-tab client-tab--active" data-tab="spese-societa" onclick="showClientTab(&#39;spese-societa&#39;)" style="border-radius: var(--radius-base) var(--radius-base) 0 0;">Spese Società</button>
                            <button class="btn btn--secondary client-tab" data-tab="spese-sonia" onclick="showClientTab(&#39;spese-sonia&#39;)" style="border-radius: var(--radius-base) var(--radius-base) 0 0;">Spese Personali Sonia</button>
                            <button class="btn btn--secondary client-tab" data-tab="spese-stefano" onclick="showClientTab(&#39;spese-stefano&#39;)" style="border-radius: var(--radius-base) var(--radius-base) 0 0;">Spese Personali Stefano</button>
                            <button class="btn btn--secondary client-tab" data-tab="entrate-societa" onclick="showClientTab(&#39;entrate-societa&#39;)" style="border-radius: var(--radius-base) var(--radius-base) 0 0;">Entrate Società</button>
                            <button class="btn btn--secondary client-tab" data-tab="entrate-sonia" onclick="showClientTab(&#39;entrate-sonia&#39;)" style="border-radius: var(--radius-base) var(--radius-base) 0 0;">Entrate Personali Sonia</button>
                            <button class="btn btn--secondary client-tab" data-tab="entrate-stefano" onclick="showClientTab(&#39;entrate-stefano&#39;)" style="border-radius: var(--radius-base) var(--radius-base) 0 0;">Entrate Personali Stefano</button>
                            <button class="btn btn--secondary client-tab" data-tab="tutte" onclick="showClientTab(&#39;tutte&#39;)" style="border-radius: var(--radius-base) var(--radius-base) 0 0;">Tutte</button>
                        </div>
                    </div>

                    <!-- Client Quick Actions -->
                    <div class="quick-actions" style="margin-bottom: var(--space-32);">
                        <button class="btn btn--primary" onclick="showModal(&#39;expense-modal&#39;); preSelectClient(currentClientId);">+ Aggiungi Spesa per questo Cliente</button>
                        <button class="btn btn--primary" onclick="showModal(&#39;income-modal&#39;); preSelectClient(currentClientId);">+ Aggiungi Entrata per questo Cliente</button>
                    </div>



                    <!-- Client Tab Content -->
                    <div id="client-tab-spese-societa" class="client-tab-content" style="display: block;">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Descrizione</th>
                                        <th>Importo</th>
                                        <th>Pagato da</th>
                                        <th>Categoria</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody id="client-spese-societa-table">
            <tr>
                <td>18/10/2025</td>
                <td>Pulizie extra</td>
                <td class="amount--negative">75,00&nbsp;€</td>
        <td>Sonia</td>
                <td>Pulizie</td>
                <td>
                    <button class="btn btn--sm btn--secondary" onclick="deleteItem(&#39;expenses&#39;, 6)">Elimina</button>
                </td>
            </tr>
        
            <tr>
                <td>17/10/2025</td>
                <td>Riparazione rubinetto</td>
                <td class="amount--negative">75,00&nbsp;€</td>
        <td>Stefano</td>
                <td>Manutenzione</td>
                <td>
                    <button class="btn btn--sm btn--secondary" onclick="deleteItem(&#39;expenses&#39;, 7)">Elimina</button>
                </td>
            </tr>
        </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="client-tab-spese-sonia" class="client-tab-content" style="display: none;">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Descrizione</th>
                                        <th>Importo</th>
                                        <th>Categoria</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody id="client-spese-sonia-table"></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="client-tab-spese-stefano" class="client-tab-content" style="display: none;">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Descrizione</th>
                                        <th>Importo</th>
                                        <th>Categoria</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody id="client-spese-stefano-table"></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="client-tab-entrate-societa" class="client-tab-content" style="display: none;">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Descrizione</th>
                                        <th>Importo</th>
                                        <th>Ricevuto da</th>
                                        <th>Categoria</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody id="client-entrate-societa-table">
            <tr>
                <td>19/10/2025</td>
                <td>Pagamento servizi extra</td>
                <td class="amount--positive">75,00&nbsp;€</td>
        <td>Sonia</td>
                <td>Servizi Extra</td>
                <td>
                    <button class="btn btn--sm btn--secondary" onclick="deleteItem(&#39;income&#39;, 5)">Elimina</button>
                </td>
            </tr>
        
            <tr>
                <td>16/10/2025</td>
                <td>Rimborso danni</td>
                <td class="amount--positive">75,00&nbsp;€</td>
        <td>Stefano</td>
                <td>Danni Ospiti</td>
                <td>
                    <button class="btn btn--sm btn--secondary" onclick="deleteItem(&#39;income&#39;, 6)">Elimina</button>
                </td>
            </tr>
        </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="client-tab-entrate-sonia" class="client-tab-content" style="display: none;">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Descrizione</th>
                                        <th>Importo</th>
                                        <th>Categoria</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody id="client-entrate-sonia-table"></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="client-tab-entrate-stefano" class="client-tab-content" style="display: none;">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Descrizione</th>
                                        <th>Importo</th>
                                        <th>Categoria</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody id="client-entrate-stefano-table"></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="client-tab-tutte" class="client-tab-content" style="display: none;">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Tipo</th>
                                        <th>Descrizione</th>
                                        <th>Importo</th>
                                        <th>Tipo Transazione</th>
                                        <th>Pagato/Ricevuto da</th>
                                        <th>Categoria</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody id="client-tutte-table">
            <tr>
                <td>19/10/2025</td>
                <td><span class="status status--success">Entrata</span></td>
                <td>Pagamento servizi extra</td>
                <td class="amount--positive">75,00&nbsp;€</td>
                <td><span class="tipo-badge tipo-badge--company">Società WiB</span></td>
                <td>
                    <span class="person-badge sonia">Sonia</span>
                </td>
                <td>Servizi Extra</td>
                <td>
                    <button class="btn btn--sm btn--secondary" onclick="deleteItem(&#39;income&#39;, 5)">Elimina</button>
                </td>
            </tr>
        
            <tr>
                <td>18/10/2025</td>
                <td><span class="status status--error">Spesa</span></td>
                <td>Pulizie extra</td>
                <td class="amount--negative">75,00&nbsp;€</td>
                <td><span class="tipo-badge tipo-badge--company">Società WiB</span></td>
                <td>
                    <span class="person-badge sonia">Sonia</span>
                </td>
                <td>Pulizie</td>
                <td>
                    <button class="btn btn--sm btn--secondary" onclick="deleteItem(&#39;expenses&#39;, 6)">Elimina</button>
                </td>
            </tr>
        
            <tr>
                <td>17/10/2025</td>
                <td><span class="status status--error">Spesa</span></td>
                <td>Riparazione rubinetto</td>
                <td class="amount--negative">75,00&nbsp;€</td>
                <td><span class="tipo-badge tipo-badge--company">Società WiB</span></td>
                <td>
                    <span class="person-badge stefano">Stefano</span>
                </td>
                <td>Manutenzione</td>
                <td>
                    <button class="btn btn--sm btn--secondary" onclick="deleteItem(&#39;expenses&#39;, 7)">Elimina</button>
                </td>
            </tr>
        
            <tr>
                <td>16/10/2025</td>
                <td><span class="status status--success">Entrata</span></td>
                <td>Rimborso danni</td>
                <td class="amount--positive">75,00&nbsp;€</td>
                <td><span class="tipo-badge tipo-badge--company">Società WiB</span></td>
                <td>
                    <span class="person-badge stefano">Stefano</span>
                </td>
                <td>Danni Ospiti</td>
                <td>
                    <button class="btn btn--sm btn--secondary" onclick="deleteItem(&#39;income&#39;, 6)">Elimina</button>
                </td>
            </tr>
        </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Impostazioni View -->
                <div id="impostazioni-view" class="view">
                    <h1>Impostazioni</h1>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-24);">
                        <div class="card">
                            <div class="card__body">
                                <h3>Gestione Dati</h3>
                                <div style="display: flex; flex-direction: column; gap: var(--space-12);">
                                    <button class="btn btn--primary" onclick="exportData()">Esporta Dati (JSON)</button>
                                    <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importData(this)">
                                    <button class="btn btn--secondary" onclick="document.getElementById(&#39;import-file&#39;).click()">Importa Dati (JSON)</button>
                                    <button class="btn btn--secondary" onclick="exportCSV(&#39;expenses&#39;)">Esporta Spese (CSV)</button>
                                    <button class="btn btn--secondary" onclick="exportCSV(&#39;income&#39;)">Esporta Entrate (CSV)</button>
                                    <button class="btn btn--secondary" onclick="exportCSV(&#39;transfers&#39;)">Esporta Bonifici (CSV)</button>
                    <button class="btn btn--secondary" onclick="clearAllData()" style="background: var(--color-error); color: var(--color-btn-primary-text); margin-top: var(--space-12);">Cancella Tutti i Dati</button>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card__body">
                                <h3>Categorie</h3>
                                <div style="margin-bottom: var(--space-16);">
                                    <h4>Categorie Spese</h4>
                                    <div id="expense-categories-list">
        <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-8); border-bottom: 1px solid var(--color-border);">
                <span>Utilities</span>
                <div>
                    <button class="btn btn--sm btn--secondary" onclick="editCategory(&#39;expenses&#39;, &#39;Utilities&#39;)">Modifica</button>
                    <button class="btn btn--sm btn--secondary" onclick="deleteCategory(&#39;expenses&#39;, &#39;Utilities&#39;)" style="margin-left: var(--space-4);">Elimina</button>
                </div>
            </div><div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-8); border-bottom: 1px solid var(--color-border);">
                <span>Manutenzione</span>
                <div>
                    <button class="btn btn--sm btn--secondary" onclick="editCategory(&#39;expenses&#39;, &#39;Manutenzione&#39;)">Modifica</button>
                    <button class="btn btn--sm btn--secondary" onclick="deleteCategory(&#39;expenses&#39;, &#39;Manutenzione&#39;)" style="margin-left: var(--space-4);">Elimina</button>
                </div>
            </div><div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-8); border-bottom: 1px solid var(--color-border);">
                <span>Pulizie</span>
                <div>
                    <button class="btn btn--sm btn--secondary" onclick="editCategory(&#39;expenses&#39;, &#39;Pulizie&#39;)">Modifica</button>
                    <button class="btn btn--sm btn--secondary" onclick="deleteCategory(&#39;expenses&#39;, &#39;Pulizie&#39;)" style="margin-left: var(--space-4);">Elimina</button>
                </div>
            </div><div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-8); border-bottom: 1px solid var(--color-border);">
                <span>Biancheria</span>
                <div>
                    <button class="btn btn--sm btn--secondary" onclick="editCategory(&#39;expenses&#39;, &#39;Biancheria&#39;)">Modifica</button>
                    <button class="btn btn--sm btn--secondary" onclick="deleteCategory(&#39;expenses&#39;, &#39;Biancheria&#39;)" style="margin-left: var(--space-4);">Elimina</button>
                </div>
            </div><div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-8); border-bottom: 1px solid var(--color-border);">
                <span>Commissioni</span>
                <div>
                    <button class="btn btn--sm btn--secondary" onclick="editCategory(&#39;expenses&#39;, &#39;Commissioni&#39;)">Modifica</button>
                    <button class="btn btn--sm btn--secondary" onclick="deleteCategory(&#39;expenses&#39;, &#39;Commissioni&#39;)" style="margin-left: var(--space-4);">Elimina</button>
                </div>
            </div><div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-8); border-bottom: 1px solid var(--color-border);">
                <span>Forniture</span>
                <div>
                    <button class="btn btn--sm btn--secondary" onclick="editCategory(&#39;expenses&#39;, &#39;Forniture&#39;)">Modifica</button>
                    <button class="btn btn--sm btn--secondary" onclick="deleteCategory(&#39;expenses&#39;, &#39;Forniture&#39;)" style="margin-left: var(--space-4);">Elimina</button>
                </div>
            </div><div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-8); border-bottom: 1px solid var(--color-border);">
                <span>Marketing</span>
                <div>
                    <button class="btn btn--sm btn--secondary" onclick="editCategory(&#39;expenses&#39;, &#39;Marketing&#39;)">Modifica</button>
                    <button class="btn btn--sm btn--secondary" onclick="deleteCategory(&#39;expenses&#39;, &#39;Marketing&#39;)" style="margin-left: var(--space-4);">Elimina</button>
                </div>
            </div><div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-8); border-bottom: 1px solid var(--color-border);">
                <span>Altro</span>
                <div>
                    <button class="btn btn--sm btn--secondary" onclick="editCategory(&#39;expenses&#39;, &#39;Altro&#39;)">Modifica</button>
                    <button class="btn btn--sm btn--secondary" onclick="deleteCategory(&#39;expenses&#39;, &#39;Altro&#39;)" style="margin-left: var(--space-4);">Elimina</button>
                </div>
            </div>
        <div style="padding: var(--space-8); border-top: 1px solid var(--color-border);">
            <div style="display: flex; gap: var(--space-8);">
                <input type="text" id="new-expense-category" placeholder="Nome nuova categoria" class="form-control" style="flex: 1;">
                <button class="btn btn--primary" onclick="addCategory(&#39;expenses&#39;)">Aggiungi</button>
            </div>
        </div>
    </div>
                                </div>
                                <div>
                                    <h4>Categorie Entrate</h4>
                                    <div id="income-categories-list">
        <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-8); border-bottom: 1px solid var(--color-border);">
                <span>Affitto</span>
                <div>
                    <button class="btn btn--sm btn--secondary" onclick="editCategory(&#39;income&#39;, &#39;Affitto&#39;)">Modifica</button>
                    <button class="btn btn--sm btn--secondary" onclick="deleteCategory(&#39;income&#39;, &#39;Affitto&#39;)" style="margin-left: var(--space-4);">Elimina</button>
                </div>
            </div><div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-8); border-bottom: 1px solid var(--color-border);">
                <span>Pulizie Extra</span>
                <div>
                    <button class="btn btn--sm btn--secondary" onclick="editCategory(&#39;income&#39;, &#39;Pulizie Extra&#39;)">Modifica</button>
                    <button class="btn btn--sm btn--secondary" onclick="deleteCategory(&#39;income&#39;, &#39;Pulizie Extra&#39;)" style="margin-left: var(--space-4);">Elimina</button>
                </div>
            </div><div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-8); border-bottom: 1px solid var(--color-border);">
                <span>Danni Ospiti</span>
                <div>
                    <button class="btn btn--sm btn--secondary" onclick="editCategory(&#39;income&#39;, &#39;Danni Ospiti&#39;)">Modifica</button>
                    <button class="btn btn--sm btn--secondary" onclick="deleteCategory(&#39;income&#39;, &#39;Danni Ospiti&#39;)" style="margin-left: var(--space-4);">Elimina</button>
                </div>
            </div><div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-8); border-bottom: 1px solid var(--color-border);">
                <span>Cauzione</span>
                <div>
                    <button class="btn btn--sm btn--secondary" onclick="editCategory(&#39;income&#39;, &#39;Cauzione&#39;)">Modifica</button>
                    <button class="btn btn--sm btn--secondary" onclick="deleteCategory(&#39;income&#39;, &#39;Cauzione&#39;)" style="margin-left: var(--space-4);">Elimina</button>
                </div>
            </div><div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-8); border-bottom: 1px solid var(--color-border);">
                <span>Servizi Extra</span>
                <div>
                    <button class="btn btn--sm btn--secondary" onclick="editCategory(&#39;income&#39;, &#39;Servizi Extra&#39;)">Modifica</button>
                    <button class="btn btn--sm btn--secondary" onclick="deleteCategory(&#39;income&#39;, &#39;Servizi Extra&#39;)" style="margin-left: var(--space-4);">Elimina</button>
                </div>
            </div><div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-8); border-bottom: 1px solid var(--color-border);">
                <span>Altro</span>
                <div>
                    <button class="btn btn--sm btn--secondary" onclick="editCategory(&#39;income&#39;, &#39;Altro&#39;)">Modifica</button>
                    <button class="btn btn--sm btn--secondary" onclick="deleteCategory(&#39;income&#39;, &#39;Altro&#39;)" style="margin-left: var(--space-4);">Elimina</button>
                </div>
            </div>
        <div style="padding: var(--space-8); border-top: 1px solid var(--color-border);">
            <div style="display: flex; gap: var(--space-8);">
                <input type="text" id="new-income-category" placeholder="Nome nuova categoria" class="form-control" style="flex: 1;">
                <button class="btn btn--primary" onclick="addCategory(&#39;income&#39;)">Aggiungi</button>
            </div>
        </div>
    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Modals -->
        <!-- Expense Modal -->
        <div id="expense-modal" class="modal">
            <div class="modal__content">
                <div class="modal__header">
                    <h2 class="modal__title">Aggiungi Spesa</h2>
                    <button class="close-btn" onclick="hideModal(&#39;expense-modal&#39;)">×</button>
                </div>
                <form id="expense-form" onsubmit="addExpense(event)">
                    <div class="form-group">
                        <label class="form-label" for="expense-client">Cliente *</label>
                        <select id="expense-client" class="form-control" required=""><option value="">Seleziona cliente...</option><option value="1">Villa Maria</option><option value="2">Casa Azzurra</option><option value="3">Appartamento Sole</option><option value="4">Villa Vista Mare</option><option value="5">Casa Rosa</option><option value="6">Studio Centro</option><option value="7">Villa Panorama</option><option value="8">Appartamento Luna</option><option value="9">Casa Bianca</option><option value="10">Villa Tramonto</option></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="expense-date">Data</label>
                        <input type="date" id="expense-date" class="form-control" required="">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="expense-description">Descrizione</label>
                        <input type="text" id="expense-description" class="form-control" required="">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="expense-tipo">Tipo *</label>
                        <select id="expense-tipo" class="form-control" required="" onchange="handleTipoChange(&#39;expense&#39;)">
                            <option value="">Seleziona tipo...</option>
                            <option value="Personale - Sonia">Personale - Sonia</option>
                            <option value="Personale - Stefano">Personale - Stefano</option>
                            <option value="Società WiB">Società WiB (50/50)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="expense-amount">Importo (€) *</label>
                        <input type="number" id="expense-amount" class="form-control" step="0.01" required="" min="0">
                    </div>
                    <div class="form-group" id="expense-paid-by-group" style="display: none;">
                        <label class="form-label" for="expense-paid-by">Pagato da</label>
                        <select id="expense-paid-by" class="form-control">
                            <option value="Sonia">Sonia</option>
                            <option value="Stefano">Stefano</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="expense-category">Categoria</label>
                        <select id="expense-category" class="form-control" required=""><option value="Utilities">Utilities</option><option value="Manutenzione">Manutenzione</option><option value="Pulizie">Pulizie</option><option value="Biancheria">Biancheria</option><option value="Commissioni">Commissioni</option><option value="Forniture">Forniture</option><option value="Marketing">Marketing</option><option value="Altro">Altro</option></select>
                    </div>
                    <div style="display: flex; gap: var(--space-12); justify-content: flex-end;">
                        <button type="button" class="btn btn--secondary" onclick="hideModal(&#39;expense-modal&#39;)">Annulla</button>
                        <button type="submit" class="btn btn--primary">Salva</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Income Modal -->
        <div id="income-modal" class="modal">
            <div class="modal__content">
                <div class="modal__header">
                    <h2 class="modal__title">Aggiungi Entrata</h2>
                    <button class="close-btn" onclick="hideModal(&#39;income-modal&#39;)">×</button>
                </div>
                <form id="income-form" onsubmit="addIncome(event)">
                    <div class="form-group">
                        <label class="form-label" for="income-client">Cliente *</label>
                        <select id="income-client" class="form-control" required=""><option value="">Seleziona cliente...</option><option value="1">Villa Maria</option><option value="2">Casa Azzurra</option><option value="3">Appartamento Sole</option><option value="4">Villa Vista Mare</option><option value="5">Casa Rosa</option><option value="6">Studio Centro</option><option value="7">Villa Panorama</option><option value="8">Appartamento Luna</option><option value="9">Casa Bianca</option><option value="10">Villa Tramonto</option></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="income-date">Data</label>
                        <input type="date" id="income-date" class="form-control" required="">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="income-description">Descrizione</label>
                        <input type="text" id="income-description" class="form-control" required="">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="income-tipo">Tipo *</label>
                        <select id="income-tipo" class="form-control" required="" onchange="handleTipoChange(&#39;income&#39;)">
                            <option value="">Seleziona tipo...</option>
                            <option value="Personale - Sonia">Personale - Sonia</option>
                            <option value="Personale - Stefano">Personale - Stefano</option>
                            <option value="Società WiB">Società WiB (50/50)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="income-amount">Importo (€) *</label>
                        <input type="number" id="income-amount" class="form-control" step="0.01" required="" min="0">
                    </div>
                    <div class="form-group" id="income-received-by-group" style="display: none;">
                        <label class="form-label" for="income-received-by">Ricevuto da</label>
                        <select id="income-received-by" class="form-control">
                            <option value="Sonia">Sonia</option>
                            <option value="Stefano">Stefano</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="income-category">Categoria</label>
                        <select id="income-category" class="form-control" required=""><option value="Affitto">Affitto</option><option value="Pulizie Extra">Pulizie Extra</option><option value="Danni Ospiti">Danni Ospiti</option><option value="Cauzione">Cauzione</option><option value="Servizi Extra">Servizi Extra</option><option value="Altro">Altro</option></select>
                    </div>
                    <div style="display: flex; gap: var(--space-12); justify-content: flex-end;">
                        <button type="button" class="btn btn--secondary" onclick="hideModal(&#39;income-modal&#39;)">Annulla</button>
                        <button type="submit" class="btn btn--primary">Salva</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Transfer Modal -->
        <div id="transfer-modal" class="modal">
            <div class="modal__content">
                <div class="modal__header">
                    <h2 class="modal__title">Aggiungi Bonifico</h2>
                    <button class="close-btn" onclick="hideModal(&#39;transfer-modal&#39;)">×</button>
                </div>
                <form id="transfer-form" onsubmit="addTransfer(event)">
                    <div class="form-group">
                        <label class="form-label" for="transfer-date">Data</label>
                        <input type="date" id="transfer-date" class="form-control" required="">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="transfer-from">Da</label>
                            <select id="transfer-from" class="form-control" required="">
                                <option value="Sonia">Sonia</option>
                                <option value="Stefano">Stefano</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="transfer-to">A</label>
                            <select id="transfer-to" class="form-control" required="">
                                <option value="Sonia">Sonia</option>
                                <option value="Stefano">Stefano</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="transfer-amount">Importo (€)</label>
                        <input type="number" id="transfer-amount" class="form-control" step="0.01" required="">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="transfer-description">Descrizione</label>
                        <input type="text" id="transfer-description" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="transfer-status">Stato</label>
                        <select id="transfer-status" class="form-control" required="">
                            <option value="Completato">Completato</option>
                            <option value="In Attesa">In Attesa</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: var(--space-12); justify-content: flex-end;">
                        <button type="button" class="btn btn--secondary" onclick="hideModal(&#39;transfer-modal&#39;)">Annulla</button>
                        <button type="submit" class="btn btn--primary">Salva</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Client Modal -->
        <div id="client-modal" class="modal">
            <div class="modal__content">
                <div class="modal__header">
                    <h2 class="modal__title">Aggiungi Cliente</h2>
                    <button class="close-btn" onclick="hideModal(&#39;client-modal&#39;)">×</button>
                </div>
                <form id="client-form" onsubmit="addClient(event)">
                    <div class="form-group">
                        <label class="form-label" for="client-name">Nome Cliente *</label>
                        <input type="text" id="client-name" class="form-control" required="">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="client-email">Email</label>
                        <input type="email" id="client-email" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="client-phone">Telefono</label>
                        <input type="tel" id="client-phone" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="client-address">Indirizzo Proprietà</label>
                        <input type="text" id="client-address" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="client-notes">Note</label>
                        <textarea id="client-notes" class="form-control" rows="3"></textarea>
                    </div>
                    <div style="display: flex; gap: var(--space-12); justify-content: flex-end;">
                        <button type="button" class="btn btn--secondary" onclick="hideModal(&#39;client-modal&#39;)">Annulla</button>
                        <button type="submit" class="btn btn--primary">Salva</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Toast Notifications -->
        <div id="toast" class="toast"></div>
    </div>

    <!-- Chart.js CDN -->
    <script src="./index_files/chart.js.download"></script>
    
    <script>
        // Global application state
let appData = {
    expenses: [
        {
            id: 1,
            clientId: 1,
            date: "2025-10-15",
            description: "Vodafone Internet",
            amount: 214.44,
            tipo: "Società WiB",
            paidBy: "Sonia",
            category: "Utilities",
            notes: "Fibra ottica"
        },
        {
            id: 2,
            clientId: 5, // Casa Rosa
            date: "2025-10-14",
            description: "Riparazione caldaia",
            amount: 350,
            tipo: "Personale - Stefano",
            paidBy: "Stefano",
            category: "Manutenzione",
            notes: "Casa Rosa - proprietà Stefano"
        },
        {
            id: 3,
            clientId: 3,
            date: "2025-10-13",
            description: "Pulizie straordinarie",
            amount: 120,
            tipo: "Personale - Sonia",
            paidBy: "Sonia",
            category: "Pulizie",
            notes: "Appartamento Sole - proprietà Sonia"
        },
        {
            id: 4,
            clientId: 1,
            date: "2025-10-12",
            description: "Set biancheria",
            amount: 200,
            tipo: "Società WiB",
            paidBy: "Stefano",
            category: "Biancheria",
            notes: ""
        },
        {
            id: 5,
            clientId: 7,
            date: "2025-10-11",
            description: "Manutenzione piscina",
            amount: 180,
            tipo: "Società WiB",
            paidBy: "Sonia",
            category: "Manutenzione",
            notes: ""
        },
        {
            id: 6,
            clientId: 2, // Casa Azzurra
            date: "2025-10-18",
            description: "Pulizie extra",
            amount: 75,
            tipo: "Società WiB",
            paidBy: "Sonia",
            category: "Pulizie",
            notes: ""
        },
        {
            id: 7,
            clientId: 2, // Casa Azzurra
            date: "2025-10-17",
            description: "Riparazione rubinetto",
            amount: 75,
            tipo: "Società WiB",
            paidBy: "Stefano",
            category: "Manutenzione",
            notes: ""
        }
    ],
    income: [
        {
            id: 1,
            clientId: 1,
            date: "2025-10-01",
            description: "Affitto Ottobre",
            amount: 800,
            tipo: "Società WiB",
            receivedBy: "Sonia",
            category: "Affitto",
            notes: "Prenotazione Airbnb"
        },
        {
            id: 2,
            clientId: 5, // Casa Rosa
            date: "2025-10-02",
            description: "Affitto Ottobre",
            amount: 600,
            tipo: "Personale - Stefano",
            receivedBy: "Stefano",
            category: "Affitto",
            notes: "Casa Rosa - proprietà Stefano"
        },
        {
            id: 3,
            clientId: 3,
            date: "2025-10-03",
            description: "Affitto Ottobre",
            amount: 450,
            tipo: "Personale - Sonia",
            receivedBy: "Sonia",
            category: "Affitto",
            notes: "Appartamento Sole - proprietà Sonia"
        },
        {
            id: 4,
            clientId: 7,
            date: "2025-10-04",
            description: "Affitto Ottobre",
            amount: 900,
            tipo: "Società WiB",
            receivedBy: "Stefano",
            category: "Affitto",
            notes: ""
        },
        {
            id: 5,
            clientId: 2, // Casa Azzurra
            date: "2025-10-19",
            description: "Pagamento servizi extra",
            amount: 75,
            tipo: "Società WiB",
            receivedBy: "Sonia",
            category: "Servizi Extra",
            notes: ""
        },
        {
            id: 6,
            clientId: 2, // Casa Azzurra
            date: "2025-10-16",
            description: "Rimborso danni",
            amount: 75,
            tipo: "Società WiB",
            receivedBy: "Stefano",
            category: "Danni Ospiti",
            notes: ""
        }
    ],
    transfers: [
        {
            id: 1,
            date: "2025-10-16",
            description: "Bonifico da Ste a Sonia - spese società",
            from: "Stefano",
            to: "Sonia",
            amount: 1000,
            tipo: "Società",
            status: "Completato"
        }
    ],
    clients: [
        { id: 1, name: "Villa Maria", email: "maria@wib.com", phone: "+30 123 456 7890", address: "Zakynthos, Kalamaki", notes: "Proprietà società - fronte mare", propertyType: "company", createdDate: "2025-01-15", isActive: true },
        { id: 2, name: "Casa Azzurra", email: "azzurra@wib.com", phone: "+30 123 456 7891", address: "Zakynthos, Argassi", notes: "Proprietà società", propertyType: "company", createdDate: "2025-02-01", isActive: true },
        { id: 3, name: "Appartamento Sole", email: "sole@wib.com", phone: "+30 123 456 7892", address: "Zakynthos, Tsilivi", notes: "Proprietà personale Sonia", propertyType: "personal_sonia", createdDate: "2025-02-15", isActive: true },
        { id: 4, name: "Villa Vista Mare", email: "vistamare@wib.com", phone: "+30 123 456 7893", address: "Zakynthos, Vasilikos", notes: "Proprietà società - lusso", propertyType: "company", createdDate: "2025-03-01", isActive: true },
        { id: 5, name: "Casa Rosa", email: "rosa@wib.com", phone: "+30 123 456 7894", address: "Zakynthos, Laganas", notes: "Proprietà personale Stefano", propertyType: "personal_stefano", createdDate: "2025-03-15", isActive: true },
        { id: 6, name: "Studio Centro", email: "centro@wib.com", phone: "+30 123 456 7895", address: "Zakynthos, Centro", notes: "Proprietà personale Sonia", propertyType: "personal_sonia", createdDate: "2025-04-01", isActive: true },
        { id: 7, name: "Villa Panorama", email: "panorama@wib.com", phone: "+30 123 456 7896", address: "Zakynthos, Keri", notes: "Proprietà società", propertyType: "company", createdDate: "2025-04-15", isActive: true },
        { id: 8, name: "Appartamento Luna", email: "luna@wib.com", phone: "+30 123 456 7897", address: "Zakynthos, Alykes", notes: "Proprietà personale Stefano", propertyType: "personal_stefano", createdDate: "2025-05-01", isActive: true },
        { id: 9, name: "Casa Bianca", email: "bianca@wib.com", phone: "+30 123 456 7898", address: "Zakynthos, Volimes", notes: "Proprietà personale Sonia", propertyType: "personal_sonia", createdDate: "2025-05-15", isActive: true },
        { id: 10, name: "Villa Tramonto", email: "tramonto@wib.com", phone: "+30 123 456 7899", address: "Zakynthos, Porto Koukla", notes: "Proprietà personale Stefano", propertyType: "personal_stefano", createdDate: "2025-06-01", isActive: true }
    ],
    categories: {
        expenses: ["Utilities", "Manutenzione", "Pulizie", "Biancheria", "Commissioni", "Forniture", "Marketing", "Altro"],
        income: ["Affitto", "Pulizie Extra", "Danni Ospiti", "Cauzione", "Servizi Extra", "Altro"]
    },
    settings: {
        partners: [
            { name: "Sonia", color: "#2563eb" },
            { name: "Stefano", color: "#10b981" }
        ],
        currency: "EUR",
        dateFormat: "DD/MM/YYYY",
        numberFormat: "italian"
    }
};

let nextId = {
    expenses: 8,
    income: 7,
    transfers: 2,
    clients: 11
};

// Current client for detail view
let currentClientId = null;

// Charts instances
let expensesPieChart = null;
let comparisonBarChart = null;

// Initialize app when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing app...');
    console.log('Clients on load:', appData.clients.length);
    initializeApp();
});

function initializeApp() {
    console.log('Initializing app...');
    console.log('Initial clients data:', appData.clients);
    
    setupNavigation();
    populateCategories();
    populateClientSelects();
    setDefaultDates();
    updateAllViews();
    createCharts();
    
    console.log('App initialized successfully');
    
    // Show data warning periodically
    setInterval(() => {
        if (Math.random() < 0.1) { // 10% chance every interval
            showToast('Ricorda di esportare i tuoi dati regolarmente!', 'warning');
        }
    }, 300000); // Every 5 minutes
}

function setupNavigation() {
    const navLinks = document.querySelectorAll('.navbar__link');
    navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const viewName = this.getAttribute('data-view');
            showView(viewName);
            
            // Update active nav link
            navLinks.forEach(l => l.classList.remove('navbar__link--active'));
            this.classList.add('navbar__link--active');
        });
    });
}

function showView(viewName) {
    console.log('Showing view:', viewName);
    
    const views = document.querySelectorAll('.view');
    views.forEach(view => view.classList.remove('view--active'));
    
    const targetView = document.getElementById(viewName + '-view');
    if (targetView) {
        targetView.classList.add('view--active');
        
        // Update view-specific data
        switch(viewName) {
            case 'dashboard':
                updateDashboard();
                updateCharts();
                break;
            case 'spese':
                updateExpensesView();
                break;
            case 'entrate':
                updateIncomeView();
                break;
            case 'bonifici':
                updateTransfersView();
                break;
            case 'clienti':
                console.log('Calling updateClientsView()');
                updateClientsView();
                break;
            case 'impostazioni':
                updateSettingsView();
                break;
            case 'client-detail':
                updateClientDetailView();
                break;
        }
    } else {
        console.error('Target view not found:', viewName + '-view');
    }
}

function populateCategories() {
    // Populate expense categories
    const expenseCategorySelect = document.getElementById('expense-category');
    if (expenseCategorySelect) {
        expenseCategorySelect.innerHTML = '';
        appData.categories.expenses.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            expenseCategorySelect.appendChild(option);
        });
    }
    
    // Populate income categories
    const incomeCategorySelect = document.getElementById('income-category');
    if (incomeCategorySelect) {
        incomeCategorySelect.innerHTML = '';
        appData.categories.income.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            incomeCategorySelect.appendChild(option);
        });
    }
}

function populateClientSelects() {
    const selects = ['expense-client', 'income-client'];
    
    selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
            // Keep the default option
            const defaultOption = select.querySelector('option[value=""]');
            select.innerHTML = '';
            if (defaultOption) {
                select.appendChild(defaultOption.cloneNode(true));
            }
            
            appData.clients.filter(c => c.isActive).forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = client.name;
                select.appendChild(option);
            });
        }
    });
}

function setDefaultDates() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('expense-date').value = today;
    document.getElementById('income-date').value = today;
    document.getElementById('transfer-date').value = today;
    
    // Set up transfer form logic
    setupTransferFormLogic();
}

function setupTransferFormLogic() {
    const fromSelect = document.getElementById('transfer-from');
    const toSelect = document.getElementById('transfer-to');
    
    if (fromSelect && toSelect) {
        fromSelect.addEventListener('change', function() {
            if (this.value === 'Sonia') {
                toSelect.value = 'Stefano';
            } else if (this.value === 'Stefano') {
                toSelect.value = 'Sonia';
            }
        });
        
        toSelect.addEventListener('change', function() {
            if (this.value === 'Sonia') {
                fromSelect.value = 'Stefano';
            } else if (this.value === 'Stefano') {
                fromSelect.value = 'Sonia';
            }
        });
    }
}

function updateAllViews() {
    updateDashboard();
    updateExpensesView();
    updateIncomeView();
    updateTransfersView();
    updateClientsView();
    updateSettingsView();
    
    // Update client detail view if currently viewing one
    if (currentClientId && document.querySelector('.view--active').id === 'client-detail-view') {
        updateClientDetailView();
    }
}

// CORRECTED calculation function with proper "who owes whom" logic
function calculateBalances() {
    const results = {
        company: {
            total: 0,
            expenses: 0,
            income: 0,
            soniaPaid: 0,    // Money Sonia paid OUT (expenses)
            soniaReceived: 0, // Money Sonia received IN (income)
            stefanoPaid: 0,   // Money Stefano paid OUT
            stefanoReceived: 0, // Money Stefano received IN
            soniaNetContribution: 0,
            stefanoNetContribution: 0,
            eachShouldContribute: 0,
            soniaShare: 0,
            stefanoShare: 0,
            situazione: ""
        },
        personalSonia: {
            total: 0,
            expenses: 0,
            income: 0
        },
        personalStefano: {
            total: 0,
            expenses: 0,
            income: 0
        },
        transfers: {
            soniaToStefano: 0,
            stefanoToSonia: 0
        },
        byClient: {}
    };
    
    // Initialize client balances
    appData.clients.forEach(client => {
        results.byClient[client.id] = {
            company: {
                total: 0, expenses: 0, income: 0,
                soniaPaid: 0, soniaReceived: 0,
                stefanoPaid: 0, stefanoReceived: 0,
                soniaNetContribution: 0, stefanoNetContribution: 0,
                eachShouldContribute: 0,
                soniaShare: 0, stefanoShare: 0, situazione: ""
            },
            personalSonia: {total: 0, expenses: 0, income: 0},
            personalStefano: {total: 0, expenses: 0, income: 0}
        };
    });
    
    // Process expenses (stored as positive amounts like 100, 50)
    appData.expenses.forEach(exp => {
        const clientId = exp.clientId;
        const amount = exp.amount || 0;
        
        if (exp.tipo === "Società WiB") {
            // Company expense - negative impact on total
            results.company.expenses += amount;
            results.company.total -= amount; // Expenses reduce company total
            if (results.byClient[clientId]) {
                results.byClient[clientId].company.expenses += amount;
                results.byClient[clientId].company.total -= amount;
            }
            
            // Track who paid OUT (as positive amounts)
            if (exp.paidBy === "Sonia") {
                results.company.soniaPaid += amount; // Sonia paid 100
                if (results.byClient[clientId]) {
                    results.byClient[clientId].company.soniaPaid += amount;
                }
            } else {
                results.company.stefanoPaid += amount; // Stefano paid 50
                if (results.byClient[clientId]) {
                    results.byClient[clientId].company.stefanoPaid += amount;
                }
            }
        } else if (exp.tipo === "Personale - Sonia") {
            results.personalSonia.expenses += amount;
            results.personalSonia.total -= amount;
            if (results.byClient[clientId]) {
                results.byClient[clientId].personalSonia.expenses += amount;
                results.byClient[clientId].personalSonia.total -= amount;
            }
        } else if (exp.tipo === "Personale - Stefano") {
            results.personalStefano.expenses += amount;
            results.personalStefano.total -= amount;
            if (results.byClient[clientId]) {
                results.byClient[clientId].personalStefano.expenses += amount;
                results.byClient[clientId].personalStefano.total -= amount;
            }
        }
    });
    
    // Process income (stored as positive amounts like 100)
    appData.income.forEach(inc => {
        const clientId = inc.clientId;
        const amount = inc.amount || 0;
        
        if (inc.tipo === "Società WiB") {
            results.company.income += amount;
            results.company.total += amount; // Income adds to company total
            if (results.byClient[clientId]) {
                results.byClient[clientId].company.income += amount;
                results.byClient[clientId].company.total += amount;
            }
            
            // Track who received IN
            if (inc.receivedBy === "Sonia") {
                results.company.soniaReceived += amount; // Sonia received 100
                if (results.byClient[clientId]) {
                    results.byClient[clientId].company.soniaReceived += amount;
                }
            } else {
                results.company.stefanoReceived += amount;
                if (results.byClient[clientId]) {
                    results.byClient[clientId].company.stefanoReceived += amount;
                }
            }
        } else if (inc.tipo === "Personale - Sonia") {
            results.personalSonia.income += amount;
            results.personalSonia.total += amount;
            if (results.byClient[clientId]) {
                results.byClient[clientId].personalSonia.income += amount;
                results.byClient[clientId].personalSonia.total += amount;
            }
        } else if (inc.tipo === "Personale - Stefano") {
            results.personalStefano.income += amount;
            results.personalStefano.total += amount;
            if (results.byClient[clientId]) {
                results.byClient[clientId].personalStefano.income += amount;
                results.byClient[clientId].personalStefano.total += amount;
            }
        }
    });
    
    // Calculate transfers (only completed ones)
    appData.transfers.filter(t => t.status === 'Completato').forEach(transfer => {
        if (transfer.from === 'Sonia' && transfer.to === 'Stefano') {
            results.transfers.soniaToStefano += transfer.amount || 0;
        } else if (transfer.from === 'Stefano' && transfer.to === 'Sonia') {
            results.transfers.stefanoToSonia += transfer.amount || 0;
        }
    });
    
    // Calculate overall company balance using CORRECTED logic
    calculateCompanyWhoOwesWhom(results.company);
    
    // Calculate for each client
    Object.values(results.byClient).forEach(client => {
        calculateCompanyWhoOwesWhom(client.company);
    });
    
    return results;
}

function calculateCompanyWhoOwesWhom(companyData) {
    // Calculate net contribution = paid out - received in
    // If someone paid 100 and received 50, they contributed 50 net
    companyData.soniaNetContribution = companyData.soniaPaid - companyData.soniaReceived;
    companyData.stefanoNetContribution = companyData.stefanoPaid - companyData.stefanoReceived;
    
    // Calculate what each SHOULD contribute (50/50 split)
    // If company total is -150 (loss), each should contribute 75
    // If company total is -50 (loss), each should contribute 25  
    // If company total is +100 (profit), each should receive 50 (contribute -50)
    const totalLoss = -companyData.total; // If total is -150, loss is 150
    companyData.eachShouldContribute = totalLoss / 2;
    
    // Calculate difference: actual contribution vs should contribute
    const soniaDifference = companyData.soniaNetContribution - companyData.eachShouldContribute;
    
    // Determine situation
    if (Math.abs(soniaDifference) < 0.01) {
        companyData.situazione = "In pari ✓";
    } else if (soniaDifference > 0) {
        // Sonia contributed more than her share, she is owed
        companyData.situazione = `Stefano deve dare a Sonia: ${formatCurrency(Math.abs(soniaDifference))}`;
    } else {
        // Sonia contributed less than her share, she owes
        companyData.situazione = `Sonia deve dare a Stefano: ${formatCurrency(Math.abs(soniaDifference))}`;
    }
    
    // Also store shares for backward compatibility
    companyData.soniaShare = companyData.total * 0.5;
    companyData.stefanoShare = companyData.total * 0.5;
}

// Calculate totals for specific client using new structure
function calculateClientTotals(clientId) {
    const balances = calculateBalances();
    return balances.byClient[clientId] || {
        company: {total: 0, expenses: 0, income: 0, soniaShare: 0, stefanoShare: 0, soniaOwed: 0, stefanoOwed: 0},
        personalSonia: {total: 0, expenses: 0, income: 0},
        personalStefano: {total: 0, expenses: 0, income: 0}
    };
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('it-IT', {
        style: 'currency',
        currency: 'EUR'
    }).format(amount);
}

function updateDashboard() {
    const balances = calculateBalances();
    
    // Update WiB Total Balance (hero section) - ONLY company total
    document.getElementById('wib-total-balance').textContent = formatCurrency(balances.company.total);
    
    // Update Company Section
    document.getElementById('company-balance').textContent = formatCurrency(balances.company.total);
    document.getElementById('sonia-company-share').textContent = formatCurrency(balances.company.soniaShare);
    document.getElementById('stefano-company-share').textContent = formatCurrency(balances.company.stefanoShare);
    document.getElementById('company-expenses-total').textContent = formatCurrency(balances.company.expenses);
    document.getElementById('company-income-total').textContent = formatCurrency(balances.company.income);
    document.getElementById('company-situation').textContent = balances.company.situazione;
    
    // Update Personal Sonia Section
    document.getElementById('personal-sonia-balance').textContent = formatCurrency(balances.personalSonia.total);
    document.getElementById('personal-sonia-expenses').textContent = formatCurrency(balances.personalSonia.expenses);
    document.getElementById('personal-sonia-income').textContent = formatCurrency(balances.personalSonia.income);
    
    // Update Personal Stefano Section
    document.getElementById('personal-stefano-balance').textContent = formatCurrency(balances.personalStefano.total);
    document.getElementById('personal-stefano-expenses').textContent = formatCurrency(balances.personalStefano.expenses);
    document.getElementById('personal-stefano-income').textContent = formatCurrency(balances.personalStefano.income);
    
    // Update summary statistics
    const totalExpenses = balances.personalSonia.expenses + balances.personalStefano.expenses + balances.company.expenses;
    const totalIncome = balances.personalSonia.income + balances.personalStefano.income + balances.company.income;
    
    document.getElementById('total-expenses-all-card').textContent = formatCurrency(totalExpenses);
    document.getElementById('total-income-all-card').textContent = formatCurrency(totalIncome);
    document.getElementById('active-clients-count').textContent = appData.clients.filter(c => c.isActive).length;
    document.getElementById('last-update').textContent = formatDate(new Date().toISOString().split('T')[0]);
    
    // Update colors
    updateValueColor('wib-total-balance', balances.company.total);
    updateValueColor('company-balance', balances.company.total);
    updateValueColor('personal-sonia-balance', balances.personalSonia.total);
    updateValueColor('personal-stefano-balance', balances.personalStefano.total);
    updateValueColor('total-expenses-all-card', -totalExpenses);
    updateValueColor('total-income-all-card', totalIncome);
    
    // Update client summary table
    updateClientSummaryTable();
}

function updateValueColor(elementId, value) {
    const element = document.getElementById(elementId);
    element.className = element.className.replace(/summary-card__value--(positive|negative)/g, '');
    
    if (value > 0) {
        element.classList.add('summary-card__value--positive');
    } else if (value < 0) {
        element.classList.add('summary-card__value--negative');
    }
}

function updateExpensesView() {
    const balances = calculateBalances();
    
    document.getElementById('total-expenses-personal-sonia').textContent = formatCurrency(balances.personalSonia.expenses);
    document.getElementById('total-expenses-personal-stefano').textContent = formatCurrency(balances.personalStefano.expenses);
    document.getElementById('total-expenses-company').textContent = formatCurrency(balances.company.expenses);
    document.getElementById('total-expenses-overall').textContent = formatCurrency(balances.personalSonia.expenses + balances.personalStefano.expenses + balances.company.expenses);
    
    updateValueColor('total-expenses-personal-sonia', -balances.personalSonia.expenses);
    updateValueColor('total-expenses-personal-stefano', -balances.personalStefano.expenses);
    updateValueColor('total-expenses-company', -balances.company.expenses);
    updateValueColor('total-expenses-overall', -(balances.personalSonia.expenses + balances.personalStefano.expenses + balances.company.expenses));
    
    renderTable('expenses', appData.expenses);
}

function updateIncomeView() {
    const balances = calculateBalances();
    
    document.getElementById('total-income-personal-sonia').textContent = formatCurrency(balances.personalSonia.income);
    document.getElementById('total-income-personal-stefano').textContent = formatCurrency(balances.personalStefano.income);
    document.getElementById('total-income-company').textContent = formatCurrency(balances.company.income);
    document.getElementById('total-income-overall').textContent = formatCurrency(balances.personalSonia.income + balances.personalStefano.income + balances.company.income);
    
    updateValueColor('total-income-personal-sonia', balances.personalSonia.income);
    updateValueColor('total-income-personal-stefano', balances.personalStefano.income);
    updateValueColor('total-income-company', balances.company.income);
    updateValueColor('total-income-overall', balances.personalSonia.income + balances.personalStefano.income + balances.company.income);
    
    renderTable('income', appData.income);
}

function updateTransfersView() {
    const balances = calculateBalances();
    
    document.getElementById('transfers-sonia-to-stefano').textContent = formatCurrency(balances.transfers.soniaToStefano);
    document.getElementById('transfers-stefano-to-sonia').textContent = formatCurrency(balances.transfers.stefanoToSonia);
    document.getElementById('net-transfers').textContent = formatCurrency(balances.transfers.stefanoToSonia - balances.transfers.soniaToStefano);
    
    renderTable('transfers', appData.transfers);
}

function updateClientsView() {
    console.log('Updating clients view...');
    console.log('Total clients:', appData.clients.length);
    
    const clientsList = document.getElementById('clients-list');
    
    if (!clientsList) {
        console.error('ERROR: clients-list element not found!');
        return;
    }
    
    if (appData.clients.length === 0) {
        console.log('No clients found, showing empty state');
        clientsList.innerHTML = `
            <div class="card">
                <div class="card__body">
                    <h3>Nessun cliente aggiunto</h3>
                    <p>Aggiungi il tuo primo cliente per iniziare il tracking dedicato.</p>
                </div>
            </div>
        `;
    } else {
        console.log('Rendering', appData.clients.filter(c => c.isActive).length, 'active clients');
        
        const balances = calculateBalances();
        
        clientsList.innerHTML = appData.clients.filter(c => c.isActive).map(client => {
            console.log('Rendering client:', client.name);
            const clientData = balances.byClient[client.id] || {
                company: {total: 0, expenses: 0, income: 0},
                personalSonia: {total: 0, expenses: 0, income: 0},
                personalStefano: {total: 0, expenses: 0, income: 0}
            };
            
            const totalClient = clientData.company.total + clientData.personalSonia.total + clientData.personalStefano.total;
            const totalExpenses = clientData.company.expenses + clientData.personalSonia.expenses + clientData.personalStefano.expenses;
            const totalIncome = clientData.company.income + clientData.personalSonia.income + clientData.personalStefano.income;
            
            // Determine client type based on transactions and notes
            let clientTipo = 'Misto';
            let tipoBadgeColor = '#e5e7eb';
            
            if (client.notes && client.notes.includes('società')) {
                clientTipo = 'Società WiB';
                tipoBadgeColor = '#e9d5ff';
            } else if (client.notes && client.notes.includes('Sonia')) {
                clientTipo = 'Personale Sonia';
                tipoBadgeColor = '#dbeafe';
            } else if (client.notes && client.notes.includes('Stefano')) {
                clientTipo = 'Personale Stefano';
                tipoBadgeColor = '#d1fae5';
            }
            
            // Create sections HTML based on what exists
            let sectionsHTML = '';
            
            // Company section
            if (clientData.company.total !== 0) {
                const companyColor = clientData.company.total >= 0 ? 'var(--color-success)' : 'var(--color-error)';
                sectionsHTML += `
                    <div style="border-left: 3px solid #9333ea; padding-left: var(--space-12); margin-bottom: var(--space-12);">
                        <div style="font-size: var(--font-size-xs); color: #7c3aed; font-weight: var(--font-weight-bold); text-transform: uppercase; margin-bottom: var(--space-4);">SOCIETÀ WiB</div>
                        <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: ${companyColor}">${formatCurrency(clientData.company.total)}</div>
                        <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">Spese: ${formatCurrency(clientData.company.expenses)} | Entrate: ${formatCurrency(clientData.company.income)}</div>
                    </div>
                `;
            }
            
            // Personal Sonia section
            if (clientData.personalSonia.total !== 0) {
                const soniaColor = clientData.personalSonia.total >= 0 ? 'var(--color-success)' : 'var(--color-error)';
                sectionsHTML += `
                    <div style="border-left: 3px solid #2563eb; padding-left: var(--space-12); margin-bottom: var(--space-12);">
                        <div style="font-size: var(--font-size-xs); color: #2563eb; font-weight: var(--font-weight-bold); text-transform: uppercase; margin-bottom: var(--space-4);">PERSONALE SONIA</div>
                        <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: ${soniaColor}">${formatCurrency(clientData.personalSonia.total)}</div>
                    </div>
                `;
            }
            
            // Personal Stefano section
            if (clientData.personalStefano.total !== 0) {
                const stefanoColor = clientData.personalStefano.total >= 0 ? 'var(--color-success)' : 'var(--color-error)';
                sectionsHTML += `
                    <div style="border-left: 3px solid #10b981; padding-left: var(--space-12); margin-bottom: var(--space-12);">
                        <div style="font-size: var(--font-size-xs); color: #10b981; font-weight: var(--font-weight-bold); text-transform: uppercase; margin-bottom: var(--space-4);">PERSONALE STEFANO</div>
                        <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: ${stefanoColor}">${formatCurrency(clientData.personalStefano.total)}</div>
                    </div>
                `;
            }
            
            // If no transactions, show empty state
            if (sectionsHTML === '') {
                sectionsHTML = '<div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); text-align: center; padding: var(--space-16);">Nessuna transazione</div>';
            }
            
            const totalClientColor = totalClient >= 0 ? 'var(--color-success)' : 'var(--color-error)';
            const addressHtml = client.address ? `<div style="font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-top: var(--space-12);">${client.address}</div>` : '';
            
            return `
                <div class="card client-card" style="cursor: pointer; transition: transform 0.2s ease;" 
                     onmouseover="this.style.transform='translateY(-2px)'" 
                     onmouseout="this.style.transform='translateY(0)'" 
                     onclick="viewClientDetail(${client.id})">
                    <div class="card__body">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-16);">
                            <h3 style="margin: 0; color: var(--color-text);">${client.name}</h3>
                            <div style="background: ${tipoBadgeColor}; padding: var(--space-4) var(--space-8); border-radius: var(--radius-full); font-size: var(--font-size-xs); font-weight: var(--font-weight-medium);">
                                ${clientTipo}
                            </div>
                        </div>
                        
                        ${sectionsHTML}
                        
                        <div style="border-top: 1px solid var(--color-border); padding-top: var(--space-12); margin-top: var(--space-16);">
                            <div style="display: flex; justify-content: between; align-items: center;">
                                <strong>TOTALE CLIENTE:</strong>
                                <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: ${totalClientColor}">
                                    ${formatCurrency(totalClient)}
                                </div>
                            </div>
                        </div>
                        
                        ${addressHtml}
                        
                        <div style="display: flex; gap: var(--space-8); margin-top: var(--space-16);">
                            <button class="btn btn--sm btn--primary" onclick="event.stopPropagation(); viewClientDetail(${client.id})" style="flex: 1;">
                                Apri Scheda
                            </button>
                            <button class="btn btn--sm btn--secondary" onclick="event.stopPropagation(); editClient(${client.id})" title="Modifica">
                                ✏️
                            </button>
                            <button class="btn btn--sm btn--secondary" onclick="event.stopPropagation(); deleteClient(${client.id})" title="Elimina">
                                🗑️
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        console.log('Clients view rendered successfully');
    }
}

function updateClientSummaryTable() {
    const tbody = document.getElementById('client-summary-table');
    if (!tbody) return;
    
    console.log('Updating client summary table with', appData.clients.filter(c => c.isActive).length, 'clients');
    
    const balances = calculateBalances();
    
    tbody.innerHTML = appData.clients.filter(c => c.isActive).map(client => {
        const clientData = balances.byClient[client.id] || {
            company: {total: 0, expenses: 0, income: 0},
            personalSonia: {total: 0, expenses: 0, income: 0},
            personalStefano: {total: 0, expenses: 0, income: 0}
        };
        
        const totalClient = clientData.company.total + clientData.personalSonia.total + clientData.personalStefano.total;
        const totalExpenses = clientData.company.expenses + clientData.personalSonia.expenses + clientData.personalStefano.expenses;
        const totalIncome = clientData.company.income + clientData.personalSonia.income + clientData.personalStefano.income;
        
        // Get transaction count for this client
        const clientExpenses = appData.expenses.filter(e => e.clientId === client.id);
        const clientIncome = appData.income.filter(i => i.clientId === client.id);
        const transactionCount = clientExpenses.length + clientIncome.length;
        const hasTransactions = transactionCount > 0;
        const isBalanced = Math.abs(totalClient) < 0.01 && hasTransactions;
        
        // Determine situation - FIXED LOGIC
        let situationText = '';
        if (!hasTransactions) {
            situationText = '<span style="color: var(--color-text-secondary);">Nessuna transazione</span>';
        } else if (isBalanced) {
            situationText = '<span style="color: var(--color-success);">✓ In pari</span>';
        } else if (totalClient > 0) {
            situationText = '<span style="color: var(--color-success);">Attivo (+)</span>';
        } else {
            situationText = '<span style="color: var(--color-error);">Passivo (-)</span>';
        }
        
        // Enhanced client info with breakdown for clients with transactions
        let clientNameDisplay = client.name;
        if (hasTransactions) {
            let breakdown = [];
            if (totalExpenses > 0) breakdown.push(`Spese: ${formatCurrency(totalExpenses)}`);
            if (totalIncome > 0) breakdown.push(`Entrate: ${formatCurrency(totalIncome)}`);
            if (breakdown.length > 0) {
                const breakdownText = breakdown.join(' | ') + ' | ' + transactionCount + ' transazioni';
                clientNameDisplay += '<br><small style="color: var(--color-text-secondary);">' + breakdownText + '</small>';
            }
        }
        
        return `
            <tr onclick="viewClientDetail(${client.id})" style="cursor: pointer;">
                <td style="font-weight: var(--font-weight-medium);">${clientNameDisplay}</td>
                <td class="${totalClient >= 0 ? 'amount--positive' : 'amount--negative'}" style="font-weight: var(--font-weight-bold);">
                    ${formatCurrency(totalClient)}
                    ${isBalanced ? ' ✓' : ''}
                </td>
                <td class="${totalExpenses > 0 ? 'amount--negative' : ''}">${totalExpenses > 0 ? formatCurrency(totalExpenses) : '-'}</td>
                <td class="${totalIncome > 0 ? 'amount--positive' : ''}">${totalIncome > 0 ? formatCurrency(totalIncome) : '-'}</td>
                <td>${situationText}</td>
                <td>
                    <button class="btn btn--sm btn--primary" onclick="event.stopPropagation(); viewClientDetail(${client.id})">Apri Scheda</button>
                </td>
            </tr>
        `;
    }).join('');
}

function getLastTransactionDate(clientId) {
    const clientExpenses = appData.expenses.filter(e => e.clientId === clientId);
    const clientIncome = appData.income.filter(i => i.clientId === clientId);
    const allTransactions = [...clientExpenses, ...clientIncome];
    
    if (allTransactions.length === 0) return null;
    
    const dates = allTransactions.map(t => new Date(t.date));
    return Math.max(...dates);
}

function viewClientDetail(clientId) {
    console.log('Opening client detail for ID:', clientId);
    const client = appData.clients.find(c => c.id === clientId);
    if (!client) {
        console.error('Client not found with ID:', clientId);
        return;
    }
    
    console.log('Found client:', client.name);
    currentClientId = clientId;
    showView('client-detail');
    updateActiveNav('clienti'); // Keep clienti nav active
    updateClientDetailView();
    
    // Reset active tab to company expenses
    showClientTab('spese-societa');
}

function updateClientDetailView() {
    if (!currentClientId) return;
    
    const client = appData.clients.find(c => c.id === currentClientId);
    if (!client) return;
    
    const clientData = calculateClientTotals(currentClientId);
    
    // Get all transactions for activity summary
    const clientExpenses = appData.expenses.filter(e => e.clientId === currentClientId);
    const clientIncome = appData.income.filter(i => i.clientId === currentClientId);
    const allTransactions = [...clientExpenses, ...clientIncome];
    const hasTransactions = allTransactions.length > 0;
    const transactionCount = allTransactions.length;
    const totalExpenses = clientExpenses.reduce((sum, e) => sum + e.amount, 0);
    const totalIncome = clientIncome.reduce((sum, i) => sum + i.amount, 0);
    
    // Get last transaction date
    let lastTransactionDate = null;
    if (hasTransactions) {
        const dates = allTransactions.map(t => new Date(t.date));
        lastTransactionDate = new Date(Math.max(...dates));
    }
    
    // Update header (simplified - no activity summary here)
    document.getElementById('client-detail-name').textContent = client.name;
    document.getElementById('client-detail-info').innerHTML = `
        ${client.email ? `Email: ${client.email}` : ''} 
        ${client.phone ? `| Tel: ${client.phone}` : ''}
        ${client.address ? `<br>Indirizzo: ${client.address}` : ''}
    `;
    
    // Show/hide sections based on what exists
    const companyCard = document.getElementById('client-company-card');
    const soniaCard = document.getElementById('client-sonia-card');
    const stefanoCard = document.getElementById('client-stefano-card');
    
    // Update Company Section - show if has transactions OR total !== 0
    const hasCompanyTransactions = clientExpenses.some(e => e.tipo === 'Società WiB') || clientIncome.some(i => i.tipo === 'Società WiB');
    if (clientData.company.total !== 0 || hasCompanyTransactions) {
        companyCard.style.display = 'block';
        document.getElementById('client-company-name').textContent = client.name;
        
        // Show balance with checkmark if balanced but has transactions
        const isBalanced = Math.abs(clientData.company.total) < 0.01 && hasCompanyTransactions;
        const balanceElement = document.getElementById('client-company-balance');
        balanceElement.innerHTML = `${formatCurrency(clientData.company.total)} ${isBalanced ? '<span style="color: #10b981; margin-left: 8px;">✓ In pari</span>' : ''}`;
        
        document.getElementById('client-company-expenses').textContent = formatCurrency(clientData.company.expenses);
        document.getElementById('client-company-income').textContent = formatCurrency(clientData.company.income);
        document.getElementById('client-sonia-company-share').textContent = formatCurrency(clientData.company.soniaShare);
        document.getElementById('client-stefano-company-share').textContent = formatCurrency(clientData.company.stefanoShare);
        
        // Show paid/received breakdown
        const companyExpenses = clientExpenses.filter(e => e.tipo === 'Società WiB');
        const companyIncomes = clientIncome.filter(i => i.tipo === 'Società WiB');
        const soniaPaid = companyExpenses.filter(e => e.paidBy === 'Sonia').reduce((sum, e) => sum + e.amount, 0);
        const stefanoPaid = companyExpenses.filter(e => e.paidBy === 'Stefano').reduce((sum, e) => sum + e.amount, 0);
        const soniaReceived = companyIncomes.filter(i => i.receivedBy === 'Sonia').reduce((sum, i) => sum + i.amount, 0);
        const stefanoReceived = companyIncomes.filter(i => i.receivedBy === 'Stefano').reduce((sum, i) => sum + i.amount, 0);
        
        document.getElementById('client-company-paid-sonia').textContent = formatCurrency(soniaPaid);
        document.getElementById('client-company-received-sonia').textContent = formatCurrency(soniaReceived);
        document.getElementById('client-company-net-sonia').textContent = formatCurrency(soniaPaid - soniaReceived);
        document.getElementById('client-company-paid-stefano').textContent = formatCurrency(stefanoPaid);
        document.getElementById('client-company-received-stefano').textContent = formatCurrency(stefanoReceived);
        document.getElementById('client-company-net-stefano').textContent = formatCurrency(stefanoPaid - stefanoReceived);
        
        // Company situation using corrected field
        document.getElementById('client-company-situation').textContent = clientData.company.situazione || (isBalanced ? 'In pari ✓' : 'Conti in pari');
        updateValueColor('client-company-balance', clientData.company.total);
    } else {
        companyCard.style.display = 'none';
    }
    
    // Update Personal Sonia Section - show if has transactions OR total !== 0
    const hasSoniaTransactions = clientExpenses.some(e => e.tipo === 'Personale - Sonia') || clientIncome.some(i => i.tipo === 'Personale - Sonia');
    if (clientData.personalSonia.total !== 0 || hasSoniaTransactions) {
        soniaCard.style.display = 'block';
        const soniaIsBalanced = Math.abs(clientData.personalSonia.total) < 0.01 && hasSoniaTransactions;
        const soniaBalanceElement = document.getElementById('client-personal-sonia-balance');
        soniaBalanceElement.innerHTML = `${formatCurrency(clientData.personalSonia.total)} ${soniaIsBalanced ? '<span style="color: #10b981; margin-left: 8px;">✓ In pari</span>' : ''}`;
        
        document.getElementById('client-personal-sonia-expenses').textContent = formatCurrency(clientData.personalSonia.expenses);
        document.getElementById('client-personal-sonia-income').textContent = formatCurrency(clientData.personalSonia.income);
        updateValueColor('client-personal-sonia-balance', clientData.personalSonia.total);
    } else {
        soniaCard.style.display = 'none';
    }
    
    // Update Personal Stefano Section - show if has transactions OR total !== 0
    const hasStefanoTransactions = clientExpenses.some(e => e.tipo === 'Personale - Stefano') || clientIncome.some(i => i.tipo === 'Personale - Stefano');
    if (clientData.personalStefano.total !== 0 || hasStefanoTransactions) {
        stefanoCard.style.display = 'block';
        const stefanoIsBalanced = Math.abs(clientData.personalStefano.total) < 0.01 && hasStefanoTransactions;
        const stefanoBalanceElement = document.getElementById('client-personal-stefano-balance');
        stefanoBalanceElement.innerHTML = `${formatCurrency(clientData.personalStefano.total)} ${stefanoIsBalanced ? '<span style="color: #10b981; margin-left: 8px;">✓ In pari</span>' : ''}`;
        
        document.getElementById('client-personal-stefano-expenses').textContent = formatCurrency(clientData.personalStefano.expenses);
        document.getElementById('client-personal-stefano-income').textContent = formatCurrency(clientData.personalStefano.income);
        updateValueColor('client-personal-stefano-balance', clientData.personalStefano.total);
    } else {
        stefanoCard.style.display = 'none';
    }
    
    // Update Activity Summary Card (right column - yellow/beige)
    const totalClient = clientData.company.total + clientData.personalSonia.total + clientData.personalStefano.total;
    const companyTransactionCount = clientExpenses.filter(e => e.tipo === 'Società WiB').length + clientIncome.filter(i => i.tipo === 'Società WiB').length;
    const soniaTransactionCount = clientExpenses.filter(e => e.tipo === 'Personale - Sonia').length + clientIncome.filter(i => i.tipo === 'Personale - Sonia').length;
    const stefanoTransactionCount = clientExpenses.filter(e => e.tipo === 'Personale - Stefano').length + clientIncome.filter(i => i.tipo === 'Personale - Stefano').length;
    
    // Populate activity summary stats
    document.getElementById('client-activity-total-transactions').textContent = transactionCount;
    document.getElementById('client-activity-total-expenses').textContent = formatCurrency(totalExpenses);
    document.getElementById('client-activity-total-income').textContent = formatCurrency(totalIncome);
    document.getElementById('client-activity-last-transaction').textContent = lastTransactionDate ? formatDate(lastTransactionDate.toISOString().split('T')[0]) : 'N/A';
    
    // Populate breakdown by type
    document.getElementById('client-activity-company-amount').textContent = formatCurrency(clientData.company.total);
    document.getElementById('client-activity-company-count').textContent = `${companyTransactionCount} transazioni`;
    document.getElementById('client-activity-sonia-amount').textContent = formatCurrency(clientData.personalSonia.total);
    document.getElementById('client-activity-sonia-count').textContent = `${soniaTransactionCount} transazioni`;
    document.getElementById('client-activity-stefano-amount').textContent = formatCurrency(clientData.personalStefano.total);
    document.getElementById('client-activity-stefano-count').textContent = `${stefanoTransactionCount} transazioni`;
    
    // Update totals
    const totalIsBalanced = Math.abs(totalClient) < 0.01 && hasTransactions;
    const totalAmountElement = document.getElementById('client-activity-total-amount');
    totalAmountElement.innerHTML = `${formatCurrency(totalClient)} ${totalIsBalanced ? '<span style="color: #10b981;">✓</span>' : ''}`;
    document.getElementById('client-activity-total-count').textContent = `Totale: ${transactionCount}`;
    
    // Update colors for activity summary amounts
    updateValueColor('client-activity-company-amount', clientData.company.total);
    updateValueColor('client-activity-sonia-amount', clientData.personalSonia.total);
    updateValueColor('client-activity-stefano-amount', clientData.personalStefano.total);
    updateValueColor('client-activity-total-amount', totalClient);
    
    // Show/hide rows based on activity
    const companyRow = document.getElementById('client-activity-company-row');
    const soniaRow = document.getElementById('client-activity-sonia-row');
    const stefanoRow = document.getElementById('client-activity-stefano-row');
    
    // Show all rows but mark inactive ones with reduced opacity
    if (companyTransactionCount === 0) {
        companyRow.style.opacity = '0.5';
    } else {
        companyRow.style.opacity = '1';
    }
    
    if (soniaTransactionCount === 0) {
        soniaRow.style.opacity = '0.5';
    } else {
        soniaRow.style.opacity = '1';
    }
    
    if (stefanoTransactionCount === 0) {
        stefanoRow.style.opacity = '0.5';
    } else {
        stefanoRow.style.opacity = '1';
    }
    
    // Update tables
    updateClientTables();
}

function updateClientTables() {
    if (!currentClientId) return;
    
    // Update all tab contents
    updateClientTabContent('spese-societa');
    updateClientTabContent('spese-sonia');
    updateClientTabContent('spese-stefano');
    updateClientTabContent('entrate-societa');
    updateClientTabContent('entrate-sonia');
    updateClientTabContent('entrate-stefano');
    updateClientTabContent('tutte');
}

function renderClientTable(tableId, type, data) {
    const tbody = document.getElementById(tableId);
    if (!tbody) return;
    
    tbody.innerHTML = data.map(item => {
        let soniaAmount = 0;
        let stefanoAmount = 0;
        
        if (item.tipo === 'Personale - Sonia') {
            soniaAmount = item.amount || 0;
        } else if (item.tipo === 'Personale - Stefano') {
            stefanoAmount = item.amount || 0;
        } else if (item.tipo === 'Società WiB') {
            const halfAmount = (item.amount || 0) / 2;
            soniaAmount = halfAmount;
            stefanoAmount = halfAmount;
        }
        
        switch(type) {
            case 'expenses':
                return `
                    <tr>
                        <td>${formatDate(item.date)}</td>
                        <td>${item.description}</td>
                        <td class="amount--negative">${soniaAmount > 0 ? formatCurrency(soniaAmount) : '-'}</td>
                        <td class="amount--negative">${stefanoAmount > 0 ? formatCurrency(stefanoAmount) : '-'}</td>
                        <td>${item.category}</td>
                        <td>
                            <button class="btn btn--sm btn--secondary" onclick="deleteItem('expenses', ${item.id})">Elimina</button>
                        </td>
                    </tr>
                `;
            case 'income':
                return `
                    <tr>
                        <td>${formatDate(item.date)}</td>
                        <td>${item.description}</td>
                        <td class="amount--positive">${soniaAmount > 0 ? formatCurrency(soniaAmount) : '-'}</td>
                        <td class="amount--positive">${stefanoAmount > 0 ? formatCurrency(stefanoAmount) : '-'}</td>
                        <td>${item.category}</td>
                        <td>
                            <button class="btn btn--sm btn--secondary" onclick="deleteItem('income', ${item.id})">Elimina</button>
                        </td>
                    </tr>
                `;
        }
    }).join('');
}

function renderClientHistoryTable() {
    if (!currentClientId) return;
    
    const tbody = document.getElementById('client-history-table');
    if (!tbody) return;
    
    // Combine all transactions for this client
    const clientExpenses = appData.expenses.filter(e => e.clientId === currentClientId).map(e => ({...e, type: 'Spesa', sortAmount: -(e.amount || 0)}));
    const clientIncome = appData.income.filter(i => i.clientId === currentClientId).map(i => ({...i, type: 'Entrata', sortAmount: i.amount || 0}));
    const allTransactions = [...clientExpenses, ...clientIncome].sort((a, b) => new Date(a.date) - new Date(b.date));
    
    let runningBalance = 0;
    
    tbody.innerHTML = allTransactions.map(item => {
        let soniaAmount = 0;
        let stefanoAmount = 0;
        
        if (item.tipo === 'Personale - Sonia') {
            soniaAmount = item.type === 'Spesa' ? -(item.amount || 0) : (item.amount || 0);
        } else if (item.tipo === 'Personale - Stefano') {
            stefanoAmount = item.type === 'Spesa' ? -(item.amount || 0) : (item.amount || 0);
        } else if (item.tipo === 'Società WiB') {
            const halfAmount = (item.type === 'Spesa' ? -(item.amount || 0) : (item.amount || 0)) / 2;
            soniaAmount = halfAmount;
            stefanoAmount = halfAmount;
        }
        
        runningBalance += (soniaAmount + stefanoAmount);
        
        return `
            <tr>
                <td>${formatDate(item.date)}</td>
                <td><span class="status ${item.type === 'Spesa' ? 'status--error' : 'status--success'}">${item.type}</span></td>
                <td>${item.description}</td>
                <td class="${soniaAmount >= 0 ? 'amount--positive' : 'amount--negative'}">${soniaAmount !== 0 ? formatCurrency(soniaAmount) : '-'}</td>
                <td class="${stefanoAmount >= 0 ? 'amount--positive' : 'amount--negative'}">${stefanoAmount !== 0 ? formatCurrency(stefanoAmount) : '-'}</td>
                <td class="${runningBalance >= 0 ? 'amount--positive' : 'amount--negative'}" style="font-weight: var(--font-weight-bold);">${formatCurrency(runningBalance)}</td>
            </tr>
        `;
    }).join('');
}

function showClientTab(tabName) {
    // Hide all tab content
    document.querySelectorAll('.client-tab-content').forEach(tab => {
        tab.style.display = 'none';
    });
    
    // Remove active class from all tabs
    document.querySelectorAll('.client-tab').forEach(tab => {
        tab.classList.remove('client-tab--active');
    });
    
    // Show selected tab content
    const tabContent = document.getElementById(`client-tab-${tabName}`);
    if (tabContent) {
        tabContent.style.display = 'block';
    }
    
    // Add active class to selected tab
    const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
    if (activeTab) {
        activeTab.classList.add('client-tab--active');
    }
    
    // Update table content based on tab
    updateClientTabContent(tabName);
}

function updateClientTabContent(tabName) {
    if (!currentClientId) return;
    
    const clientExpenses = appData.expenses.filter(e => e.clientId === currentClientId);
    const clientIncome = appData.income.filter(i => i.clientId === currentClientId);
    
    switch(tabName) {
        case 'spese-societa':
            renderClientTabTable('client-spese-societa-table', clientExpenses.filter(e => e.tipo === 'Società WiB'), 'company-expense');
            break;
        case 'spese-sonia':
            renderClientTabTable('client-spese-sonia-table', clientExpenses.filter(e => e.tipo === 'Personale - Sonia'), 'personal-expense');
            break;
        case 'spese-stefano':
            renderClientTabTable('client-spese-stefano-table', clientExpenses.filter(e => e.tipo === 'Personale - Stefano'), 'personal-expense');
            break;
        case 'entrate-societa':
            renderClientTabTable('client-entrate-societa-table', clientIncome.filter(i => i.tipo === 'Società WiB'), 'company-income');
            break;
        case 'entrate-sonia':
            renderClientTabTable('client-entrate-sonia-table', clientIncome.filter(i => i.tipo === 'Personale - Sonia'), 'personal-income');
            break;
        case 'entrate-stefano':
            renderClientTabTable('client-entrate-stefano-table', clientIncome.filter(i => i.tipo === 'Personale - Stefano'), 'personal-income');
            break;
        case 'tutte':
            renderClientAllTransactionsTable();
            break;
    }
}

function renderClientTabTable(tableId, data, type) {
    const tbody = document.getElementById(tableId);
    if (!tbody) return;
    
    tbody.innerHTML = data.map(item => {
        const isExpense = type.includes('expense');
        const amount = isExpense ? -(item.amount || 0) : (item.amount || 0);
        const colorClass = amount >= 0 ? 'amount--positive' : 'amount--negative';
        
        let row = `
            <tr>
                <td>${formatDate(item.date)}</td>
                <td>${item.description}</td>
                <td class="${colorClass}">${formatCurrency(Math.abs(item.amount || 0))}</td>
        `;
        
        if (type.includes('company')) {
            const person = isExpense ? item.paidBy : item.receivedBy;
            row += `<td>${person || 'N/A'}</td>`;
        }
        
        row += `
                <td>${item.category}</td>
                <td>
                    <button class="btn btn--sm btn--secondary" onclick="deleteItem('${isExpense ? 'expenses' : 'income'}', ${item.id})">Elimina</button>
                </td>
            </tr>
        `;
        
        return row;
    }).join('');
}

function renderClientAllTransactionsTable() {
    const tbody = document.getElementById('client-tutte-table');
    if (!tbody) return;
    
    const clientExpenses = appData.expenses.filter(e => e.clientId === currentClientId).map(e => ({...e, type: 'Spesa', handledBy: e.paidBy || 'N/A', sortAmount: -(e.amount || 0)}));
    const clientIncome = appData.income.filter(i => i.clientId === currentClientId).map(i => ({...i, type: 'Entrata', handledBy: i.receivedBy || 'N/A', sortAmount: i.amount || 0}));
    const allTransactions = [...clientExpenses, ...clientIncome].sort((a, b) => new Date(b.date) - new Date(a.date));
    
    tbody.innerHTML = allTransactions.map(item => {
        const isExpense = item.type === 'Spesa';
        const amount = isExpense ? -(item.amount || 0) : (item.amount || 0);
        const colorClass = amount >= 0 ? 'amount--positive' : 'amount--negative';
        
        return `
            <tr>
                <td>${formatDate(item.date)}</td>
                <td><span class="status ${isExpense ? 'status--error' : 'status--success'}">${item.type}</span></td>
                <td>${item.description}</td>
                <td class="${colorClass}">${formatCurrency(Math.abs(item.amount || 0))}</td>
                <td>${getTipoBadgeHtml(item.tipo || 'Società WiB')}</td>
                <td>
                    <span class="person-badge ${item.handledBy.toLowerCase()}">${item.handledBy}</span>
                </td>
                <td>${item.category}</td>
                <td>
                    <button class="btn btn--sm btn--secondary" onclick="deleteItem('${isExpense ? 'expenses' : 'income'}', ${item.id})">Elimina</button>
                </td>
            </tr>
        `;
    }).join('');
}

function preSelectClient(clientId) {
    const expenseSelect = document.getElementById('expense-client');
    const incomeSelect = document.getElementById('income-client');
    
    if (expenseSelect) expenseSelect.value = clientId;
    if (incomeSelect) incomeSelect.value = clientId;
}

function updateActiveNav(viewName) {
    document.querySelectorAll('.navbar__link').forEach(link => {
        link.classList.remove('navbar__link--active');
        if (link.getAttribute('data-view') === viewName) {
            link.classList.add('navbar__link--active');
        }
    });
}

function editClient(clientId) {
    const client = appData.clients.find(c => c.id === clientId);
    if (!client) return;
    
    // Pre-populate the form
    document.getElementById('client-name').value = client.name;
    document.getElementById('client-email').value = client.email || '';
    document.getElementById('client-phone').value = client.phone || '';
    document.getElementById('client-address').value = client.address || '';
    document.getElementById('client-notes').value = client.notes || '';
    
    // Store the ID for editing
    document.getElementById('client-form').setAttribute('data-editing', clientId);
    document.querySelector('#client-modal .modal__title').textContent = 'Modifica Cliente';
    
    showModal('client-modal');
}

function updateSettingsView() {
    // Update expense categories list
    const expenseCategoriesList = document.getElementById('expense-categories-list');
    expenseCategoriesList.innerHTML = `
        ${appData.categories.expenses.map(category => 
            `<div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-8); border-bottom: 1px solid var(--color-border);">
                <span>${category}</span>
                <div>
                    <button class="btn btn--sm btn--secondary" onclick="editCategory('expenses', '${category}')">Modifica</button>
                    <button class="btn btn--sm btn--secondary" onclick="deleteCategory('expenses', '${category}')" style="margin-left: var(--space-4);">Elimina</button>
                </div>
            </div>`
        ).join('')}
        <div style="padding: var(--space-8); border-top: 1px solid var(--color-border);">
            <div style="display: flex; gap: var(--space-8);">
                <input type="text" id="new-expense-category" placeholder="Nome nuova categoria" class="form-control" style="flex: 1;">
                <button class="btn btn--primary" onclick="addCategory('expenses')">Aggiungi</button>
            </div>
        </div>
    `;
    
    // Update income categories list
    const incomeCategoriesList = document.getElementById('income-categories-list');
    incomeCategoriesList.innerHTML = `
        ${appData.categories.income.map(category => 
            `<div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-8); border-bottom: 1px solid var(--color-border);">
                <span>${category}</span>
                <div>
                    <button class="btn btn--sm btn--secondary" onclick="editCategory('income', '${category}')">Modifica</button>
                    <button class="btn btn--sm btn--secondary" onclick="deleteCategory('income', '${category}')" style="margin-left: var(--space-4);">Elimina</button>
                </div>
            </div>`
        ).join('')}
        <div style="padding: var(--space-8); border-top: 1px solid var(--color-border);">
            <div style="display: flex; gap: var(--space-8);">
                <input type="text" id="new-income-category" placeholder="Nome nuova categoria" class="form-control" style="flex: 1;">
                <button class="btn btn--primary" onclick="addCategory('income')">Aggiungi</button>
            </div>
        </div>
    `;
}

function renderTable(type, data) {
    const tableBodyId = type + '-table-body';
    const tbody = document.getElementById(tableBodyId);
    
    if (!tbody) return;
    
    tbody.innerHTML = data.map(item => {
        switch(type) {
            case 'expenses':
                const client = appData.clients.find(c => c.id === item.clientId);
                return `
                    <tr>
                        <td class="editable-cell" data-field="date" data-id="${item.id}" onclick="startEdit(this)">${formatDate(item.date)}</td>
                        <td>${client ? client.name : 'Cliente Eliminato'}</td>
                        <td class="editable-cell" data-field="description" data-id="${item.id}" onclick="startEdit(this)">${item.description}</td>
                        <td class="amount--negative">${formatCurrency(-(item.amount || 0))}</td>
                        <td>${getTipoBadgeHtml(item.tipo || 'Società WiB')}</td>
                        <td>${item.paidBy || 'N/A'}</td>
                        <td class="editable-cell" data-field="category" data-id="${item.id}" onclick="startEdit(this)">${item.category}</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn--sm btn--secondary" onclick="deleteItem('expenses', ${item.id})">Elimina</button>
                            </div>
                        </td>
                    </tr>
                `;
            case 'income':
                const incomeClient = appData.clients.find(c => c.id === item.clientId);
                return `
                    <tr>
                        <td class="editable-cell" data-field="date" data-id="${item.id}" onclick="startEdit(this)">${formatDate(item.date)}</td>
                        <td>${incomeClient ? incomeClient.name : 'Cliente Eliminato'}</td>
                        <td class="editable-cell" data-field="description" data-id="${item.id}" onclick="startEdit(this)">${item.description}</td>
                        <td class="amount--positive">${formatCurrency(item.amount || 0)}</td>
                        <td>${getTipoBadgeHtml(item.tipo || 'Società WiB')}</td>
                        <td>${item.receivedBy || 'N/A'}</td>
                        <td class="editable-cell" data-field="category" data-id="${item.id}" onclick="startEdit(this)">${item.category}</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn--sm btn--secondary" onclick="deleteItem('income', ${item.id})">Elimina</button>
                            </div>
                        </td>
                    </tr>
                `;
            case 'transfers':
                return `
                    <tr>
                        <td class="editable-cell" data-field="date" data-id="${item.id}" onclick="startEdit(this)">${formatDate(item.date)}</td>
                        <td class="editable-cell" data-field="description" data-id="${item.id}" onclick="startEdit(this)">${item.description}</td>
                        <td>${item.from}</td>
                        <td>${item.to}</td>
                        <td class="amount--positive">${formatCurrency(item.amount)}</td>
                        <td><span class="status ${item.status === 'Completato' ? 'status--success' : 'status--warning'}">${item.status}</span></td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn--sm btn--secondary" onclick="deleteItem('transfers', ${item.id})">Elimina</button>
                            </div>
                        </td>
                    </tr>
                `;
            default:
                return '';
        }
    }).join('');
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('it-IT');
}

// Inline editing functions
let currentEdit = null;

function startEdit(cell) {
    if (currentEdit) {
        cancelEdit();
    }
    
    currentEdit = {
        cell: cell,
        originalValue: cell.textContent,
        field: cell.getAttribute('data-field'),
        id: parseInt(cell.getAttribute('data-id'))
    };
    
    cell.classList.add('editable-cell--editing');
    
    const field = currentEdit.field;
    let input;
    
    if (field === 'date') {
        input = document.createElement('input');
        input.type = 'date';
        input.value = findItemById(currentEdit.id).date;
    } else if (field === 'amountSonia' || field === 'amountStefano' || field === 'amount') {
        input = document.createElement('input');
        input.type = 'number';
        input.step = '0.01';
        const numValue = parseFloat(currentEdit.originalValue.replace(/[€\s.,]/g, '')) || 0;
        input.value = numValue;
    } else if (field === 'category') {
        input = document.createElement('select');
        const categories = getCurrentViewType() === 'expenses' ? appData.categories.expenses : appData.categories.income;
        categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            if (cat === currentEdit.originalValue) option.selected = true;
            input.appendChild(option);
        });
    } else {
        input = document.createElement('input');
        input.type = 'text';
        input.value = currentEdit.originalValue;
    }
    
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            saveEdit();
        } else if (e.key === 'Escape') {
            cancelEdit();
        }
    });
    
    input.addEventListener('blur', saveEdit);
    
    cell.innerHTML = '';
    cell.appendChild(input);
    input.focus();
}

function saveEdit() {
    if (!currentEdit) return;
    
    const input = currentEdit.cell.querySelector('input, select');
    const newValue = input.value;
    const viewType = getCurrentViewType();
    const dataArray = appData[viewType];
    const item = dataArray.find(item => item.id === currentEdit.id);
    
    if (item) {
        if (currentEdit.field === 'amountSonia' || currentEdit.field === 'amountStefano' || currentEdit.field === 'amount') {
            item[currentEdit.field] = parseFloat(newValue) || 0;
        } else {
            item[currentEdit.field] = newValue;
        }
        
        updateAllViews();
        updateCharts();
        showToast('Modifiche salvate!', 'success');
    }
    
    finishEdit();
}

function cancelEdit() {
    if (!currentEdit) return;
    
    currentEdit.cell.innerHTML = currentEdit.originalValue;
    finishEdit();
}

function finishEdit() {
    if (!currentEdit) return;
    
    currentEdit.cell.classList.remove('editable-cell--editing');
    currentEdit = null;
}

function findItemById(id) {
    const viewType = getCurrentViewType();
    return appData[viewType].find(item => item.id === id);
}

function getCurrentViewType() {
    const activeView = document.querySelector('.view--active');
    if (activeView.id === 'spese-view') return 'expenses';
    if (activeView.id === 'entrate-view') return 'income';
    if (activeView.id === 'bonifici-view') return 'transfers';
    return 'expenses';
}

// Modal functions
function showModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.add('modal--active');
    
    // Reset form if it exists
    const form = modal.querySelector('form');
    if (form) {
        form.reset();
        setDefaultDates();
        
        // Clear client selection unless pre-selected
        if (modalId === 'expense-modal' || modalId === 'income-modal') {
            populateClientSelects();
            
            // Hide paid by / received by groups initially
            if (modalId === 'expense-modal') {
                document.getElementById('expense-paid-by-group').style.display = 'none';
            } else if (modalId === 'income-modal') {
                document.getElementById('income-received-by-group').style.display = 'none';
            }
        }
    }
}

function hideModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.remove('modal--active');
}

// Form submission functions
function addExpense(event) {
    event.preventDefault();
    
    const clientId = parseInt(document.getElementById('expense-client').value);
    const tipo = document.getElementById('expense-tipo').value;
    const amount = parseFloat(document.getElementById('expense-amount').value);
    const paidBy = document.getElementById('expense-paid-by').value;
    
    if (!clientId) {
        showToast('Seleziona un cliente!', 'error');
        return;
    }
    
    if (!tipo) {
        showToast('Seleziona il tipo di spesa!', 'error');
        return;
    }
    
    if (!amount || amount <= 0) {
        showToast('Inserisci un importo valido!', 'error');
        return;
    }
    
    // For personal expenses, auto-set paidBy
    let finalPaidBy = paidBy;
    if (tipo === 'Personale - Sonia') {
        finalPaidBy = 'Sonia';
    } else if (tipo === 'Personale - Stefano') {
        finalPaidBy = 'Stefano';
    }
    
    const expense = {
        id: nextId.expenses++,
        clientId: clientId,
        date: document.getElementById('expense-date').value,
        description: document.getElementById('expense-description').value,
        amount: amount,
        tipo: tipo,
        paidBy: finalPaidBy,
        category: document.getElementById('expense-category').value,
        notes: ''
    };
    
    appData.expenses.push(expense);
    hideModal('expense-modal');
    updateAllViews();
    updateCharts();
    showToast('Spesa aggiunta con successo!', 'success');
}

function addIncome(event) {
    event.preventDefault();
    
    const clientId = parseInt(document.getElementById('income-client').value);
    const tipo = document.getElementById('income-tipo').value;
    const amount = parseFloat(document.getElementById('income-amount').value);
    const receivedBy = document.getElementById('income-received-by').value;
    
    if (!clientId) {
        showToast('Seleziona un cliente!', 'error');
        return;
    }
    
    if (!tipo) {
        showToast('Seleziona il tipo di entrata!', 'error');
        return;
    }
    
    if (!amount || amount <= 0) {
        showToast('Inserisci un importo valido!', 'error');
        return;
    }
    
    // For personal income, auto-set receivedBy
    let finalReceivedBy = receivedBy;
    if (tipo === 'Personale - Sonia') {
        finalReceivedBy = 'Sonia';
    } else if (tipo === 'Personale - Stefano') {
        finalReceivedBy = 'Stefano';
    }
    
    const income = {
        id: nextId.income++,
        clientId: clientId,
        date: document.getElementById('income-date').value,
        description: document.getElementById('income-description').value,
        amount: amount,
        tipo: tipo,
        receivedBy: finalReceivedBy,
        category: document.getElementById('income-category').value,
        notes: ''
    };
    
    appData.income.push(income);
    hideModal('income-modal');
    updateAllViews();
    updateCharts();
    showToast('Entrata aggiunta con successo!', 'success');
}

function addTransfer(event) {
    event.preventDefault();
    
    const fromPerson = document.getElementById('transfer-from').value;
    const toPerson = document.getElementById('transfer-to').value;
    
    if (fromPerson === toPerson) {
        showToast('Non puoi trasferire denaro alla stessa persona!', 'error');
        return;
    }
    
    const transfer = {
        id: nextId.transfers++,
        date: document.getElementById('transfer-date').value,
        description: document.getElementById('transfer-description').value || `Bonifico da ${fromPerson} a ${toPerson}`,
        from: fromPerson,
        to: toPerson,
        amount: parseFloat(document.getElementById('transfer-amount').value) || 0,
        status: document.getElementById('transfer-status').value
    };
    
    appData.transfers.push(transfer);
    hideModal('transfer-modal');
    updateAllViews();
    updateCharts();
    showToast('Bonifico aggiunto con successo!', 'success');
}

function addClient(event) {
    event.preventDefault();
    
    const form = document.getElementById('client-form');
    const editingId = form.getAttribute('data-editing');
    
    if (editingId) {
        // Edit existing client
        const client = appData.clients.find(c => c.id === parseInt(editingId));
        if (client) {
            client.name = document.getElementById('client-name').value;
            client.email = document.getElementById('client-email').value;
            client.phone = document.getElementById('client-phone').value;
            client.address = document.getElementById('client-address').value;
            client.notes = document.getElementById('client-notes').value;
            showToast('Cliente modificato con successo!', 'success');
        }
        form.removeAttribute('data-editing');
        document.querySelector('#client-modal .modal__title').textContent = 'Aggiungi Cliente';
    } else {
        // Add new client
        const client = {
            id: nextId.clients++,
            name: document.getElementById('client-name').value,
            email: document.getElementById('client-email').value,
            phone: document.getElementById('client-phone').value,
            address: document.getElementById('client-address').value,
            notes: document.getElementById('client-notes').value,
            createdDate: new Date().toISOString().split('T')[0],
            isActive: true
        };
        
        appData.clients.push(client);
        showToast('Cliente aggiunto con successo!', 'success');
    }
    
    hideModal('client-modal');
    populateClientSelects();
    updateAllViews();
}

// Delete functions
function deleteItem(type, id) {
    if (confirm('Sei sicuro di voler eliminare questo elemento?')) {
        const index = appData[type].findIndex(item => item.id === id);
        if (index !== -1) {
            appData[type].splice(index, 1);
            updateAllViews();
            updateCharts();
            showToast('Elemento eliminato!', 'success');
        }
    }
}

function deleteClient(id) {
    const client = appData.clients.find(c => c.id === id);
    const hasTransactions = appData.expenses.some(e => e.clientId === id) || appData.income.some(i => i.clientId === id);
    
    let confirmMessage = `Sei sicuro di voler eliminare il cliente "${client.name}"?`;
    if (hasTransactions) {
        confirmMessage += '\n\nATTENZIONE: Questo cliente ha transazioni associate che saranno mantenute ma risulteranno come "Cliente Eliminato".';
    }
    
    if (confirm(confirmMessage)) {
        const index = appData.clients.findIndex(client => client.id === id);
        if (index !== -1) {
            appData.clients.splice(index, 1);
            populateClientSelects();
            updateAllViews();
            showToast('Cliente eliminato!', 'success');
        }
    }
}

function deleteCategory(type, category) {
    if (confirm(`Sei sicuro di voler eliminare la categoria "${category}"?`)) {
        const index = appData.categories[type].indexOf(category);
        if (index !== -1) {
            appData.categories[type].splice(index, 1);
            populateCategories();
            updateSettingsView();
            showToast('Categoria eliminata!', 'success');
        }
    }
}

function addCategory(type) {
    const inputId = type === 'expenses' ? 'new-expense-category' : 'new-income-category';
    const input = document.getElementById(inputId);
    const categoryName = input.value.trim();
    
    if (!categoryName) {
        showToast('Inserisci il nome della categoria!', 'error');
        return;
    }
    
    if (appData.categories[type].includes(categoryName)) {
        showToast('Questa categoria esiste già!', 'error');
        return;
    }
    
    appData.categories[type].push(categoryName);
    input.value = '';
    populateCategories();
    updateSettingsView();
    showToast('Categoria aggiunta!', 'success');
}

function editCategory(type, oldCategory) {
    const newName = prompt('Inserisci il nuovo nome per la categoria:', oldCategory);
    
    if (newName && newName.trim() && newName !== oldCategory) {
        const trimmedName = newName.trim();
        
        if (appData.categories[type].includes(trimmedName)) {
            showToast('Questa categoria esiste già!', 'error');
            return;
        }
        
        const index = appData.categories[type].indexOf(oldCategory);
        if (index !== -1) {
            appData.categories[type][index] = trimmedName;
            
            // Update existing transactions
            if (type === 'expenses') {
                appData.expenses.forEach(expense => {
                    if (expense.category === oldCategory) {
                        expense.category = trimmedName;
                    }
                });
            } else {
                appData.income.forEach(income => {
                    if (income.category === oldCategory) {
                        income.category = trimmedName;
                    }
                });
            }
            
            populateCategories();
            updateSettingsView();
            updateAllViews();
            showToast('Categoria modificata!', 'success');
        }
    }
}

// Toast notification function
function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = `toast toast--${type} toast--show`;
    
    setTimeout(() => {
        toast.classList.remove('toast--show');
    }, 3000);
}

// Chart functions
function createCharts() {
    createExpensesPieChart();
    createComparisonBarChart();
}

function createExpensesPieChart() {
    const ctx = document.getElementById('expenses-pie-chart');
    if (!ctx) return;
    
    // Calculate expenses by category (all types combined)
    const categoryTotals = {};
    appData.expenses.forEach(expense => {
        const amount = expense.amount || 0;
        categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + amount;
    });
    
    const labels = Object.keys(categoryTotals);
    const data = Object.values(categoryTotals);
    const colors = ['#1FB8CD', '#FFC185', '#B4413C', '#ECEBD5', '#5D878F', '#DB4545', '#D2BA4C', '#964325'];
    
    if (labels.length === 0) {
        // Show empty chart message
        const canvas = ctx.getContext('2d');
        canvas.clearRect(0, 0, ctx.width, ctx.height);
        canvas.fillStyle = '#666';
        canvas.font = '16px Arial';
        canvas.textAlign = 'center';
        canvas.fillText('Nessuna spesa registrata', ctx.width / 2, ctx.height / 2);
        return;
    }
    
    if (expensesPieChart) {
        expensesPieChart.destroy();
    }
    
    expensesPieChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors.slice(0, labels.length),
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function createComparisonBarChart() {
    const ctx = document.getElementById('comparison-bar-chart');
    if (!ctx) return;
    
    const balances = calculateBalances();
    
    if (comparisonBarChart) {
        comparisonBarChart.destroy();
    }
    
    // Calculate total balances including personal + company shares
    const totalSoniaBalance = balances.personalSonia.total + balances.company.soniaShare;
    const totalStefanoBalance = balances.personalStefano.total + balances.company.stefanoShare;
    const totalSoniaExpenses = balances.personalSonia.expenses + (balances.company.expenses * 0.5);
    const totalStefanoExpenses = balances.personalStefano.expenses + (balances.company.expenses * 0.5);
    const totalSoniaIncome = balances.personalSonia.income + (balances.company.income * 0.5);
    const totalStefanoIncome = balances.personalStefano.income + (balances.company.income * 0.5);
    
    comparisonBarChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Spese', 'Entrate', 'Saldo'],
            datasets: [
                {
                    label: 'Sonia',
                    data: [
                        totalSoniaExpenses,
                        totalSoniaIncome,
                        totalSoniaBalance
                    ],
                    backgroundColor: '#2563eb',
                    borderColor: '#1d4ed8',
                    borderWidth: 1
                },
                {
                    label: 'Stefano',
                    data: [
                        totalStefanoExpenses,
                        totalStefanoIncome,
                        totalStefanoBalance
                    ],
                    backgroundColor: '#10b981',
                    borderColor: '#059669',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatCurrency(value);
                        }
                    }
                }
            }
        }
    });
}

function updateCharts() {
    if (document.querySelector('.view--active').id === 'dashboard-view') {
        createExpensesPieChart();
        createComparisonBarChart();
    }
}

// Table sorting
function sortTable(type, field) {
    const data = appData[type];
    const isAscending = !data._sortAscending || data._lastSortField !== field;
    
    data.sort((a, b) => {
        let aVal = a[field];
        let bVal = b[field];
        
        if (field === 'date') {
            aVal = new Date(aVal);
            bVal = new Date(bVal);
        } else if (typeof aVal === 'string') {
            aVal = aVal.toLowerCase();
            bVal = bVal.toLowerCase();
        }
        
        if (aVal < bVal) return isAscending ? -1 : 1;
        if (aVal > bVal) return isAscending ? 1 : -1;
        return 0;
    });
    
    data._sortAscending = isAscending;
    data._lastSortField = field;
    
    // Re-render the current view
    const activeView = document.querySelector('.view--active').id;
    if (activeView === 'spese-view') updateExpensesView();
    else if (activeView === 'entrate-view') updateIncomeView();
    else if (activeView === 'bonifici-view') updateTransfersView();
}

// Export/Import functions
function exportData() {
    const data = {
        appData: appData,
        nextId: nextId,
        exportedAt: new Date().toISOString(),
        version: '1.0'
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `wib-backup-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast('Dati esportati con successo!', 'success');
}

function importData(input) {
    const file = input.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            
            if (data.appData && data.nextId) {
                if (confirm('Importare i dati sostituirà tutti i dati correnti. Continuare?')) {
                    appData = data.appData;
                    nextId = data.nextId;
                    
                    populateCategories();
                    updateAllViews();
                    updateCharts();
                    
                    showToast('Dati importati con successo!', 'success');
                }
            } else {
                showToast('File di backup non valido!', 'error');
            }
        } catch (error) {
            showToast('Errore durante l\'importazione dei dati!', 'error');
        }
    };
    
    reader.readAsText(file);
    input.value = ''; // Reset input
}

function exportCSV(type) {
    const data = appData[type];
    if (!data.length) {
        showToast('Nessun dato da esportare!', 'warning');
        return;
    }
    
    let csv = '';
    let headers = [];
    
    switch(type) {
        case 'expenses':
            headers = ['Data', 'Cliente', 'Descrizione', 'Sonia', 'Stefano', 'Categoria'];
            csv = headers.join(',') + '\n';
            data.forEach(item => {
                const client = appData.clients.find(c => c.id === item.clientId);
                const clientName = client ? client.name : 'Cliente Eliminato';
                csv += `${item.date},"${clientName}","${item.description}",${item.amountSonia},${item.amountStefano},"${item.category}"\n`;
            });
            break;
        case 'income':
            headers = ['Data', 'Cliente', 'Descrizione', 'Sonia', 'Stefano', 'Categoria'];
            csv = headers.join(',') + '\n';
            data.forEach(item => {
                const client = appData.clients.find(c => c.id === item.clientId);
                const clientName = client ? client.name : 'Cliente Eliminato';
                csv += `${item.date},"${clientName}","${item.description}",${item.amountSonia},${item.amountStefano},"${item.category}"\n`;
            });
            break;
        case 'transfers':
            headers = ['Data', 'Descrizione', 'Da', 'A', 'Importo', 'Stato'];
            csv = headers.join(',') + '\n';
            data.forEach(item => {
                csv += `${item.date},"${item.description}","${item.from}","${item.to}",${item.amount},"${item.status}"\n`;
            });
            break;
        case 'clients':
            headers = ['Nome', 'Email', 'Telefono', 'Indirizzo', 'Note', 'Data Creazione'];
            csv = headers.join(',') + '\n';
            appData.clients.forEach(item => {
                csv += `"${item.name}","${item.email || ''}","${item.phone || ''}","${item.address || ''}","${item.notes || ''}",${item.createdDate}\n`;
            });
            break;
    }
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `wib-${type}-${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast(`${type} esportate con successo!`, 'success');
}

function clearAllData() {
    if (confirm('ATTENZIONE: Questa operazione cancellerà tutti i dati (spese, entrate, bonifici, clienti). Sei sicuro di voler continuare?')) {
        if (confirm('Questa azione non può essere annullata. Sei DAVVERO sicuro?')) {
            appData.expenses = [];
            appData.income = [];
            appData.transfers = [];
            appData.clients = [];
            
            nextId = {
                expenses: 1,
                income: 1,
                transfers: 1,
                clients: 1
            };
            
            populateClientSelects();
            updateAllViews();
            updateCharts();
            showToast('Tutti i dati sono stati cancellati!', 'success');
        }
    }
}

// Close modals when clicking outside
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal')) {
        e.target.classList.remove('modal--active');
    }
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
            case 'n':
                e.preventDefault();
                showModal('expense-modal');
                break;
            case 'i':
                e.preventDefault();
                showModal('income-modal');
                break;
            case 't':
                e.preventDefault();
                showModal('transfer-modal');
                break;
            case 's':
                e.preventDefault();
                exportData();
                break;
        }
    }
    
    if (e.key === 'Escape' && currentEdit) {
        cancelEdit();
    }
});

// Helper function for tipo badges
function getTipoBadgeClass(tipo) {
    switch(tipo) {
        case 'Personale - Sonia':
            return 'tipo-badge--personal-sonia';
        case 'Personale - Stefano':
            return 'tipo-badge--personal-stefano';
        case 'Società WiB':
            return 'tipo-badge--company';
        default:
            return 'tipo-badge--company';
    }
}

function getTipoBadgeHtml(tipo) {
    const badgeClass = getTipoBadgeClass(tipo);
    return `<span class="tipo-badge ${badgeClass}">${tipo}</span>`;
}

// Function to handle tipo selection in forms
function handleTipoChange(formType) {
    const tipoSelect = document.getElementById(`${formType}-tipo`);
    const selectedTipo = tipoSelect.value;
    
    if (formType === 'expense') {
        const paidByGroup = document.getElementById('expense-paid-by-group');
        const paidBySelect = document.getElementById('expense-paid-by');
        
        if (selectedTipo === 'Personale - Sonia') {
            paidByGroup.style.display = 'none';
            paidBySelect.value = 'Sonia';
        } else if (selectedTipo === 'Personale - Stefano') {
            paidByGroup.style.display = 'none';
            paidBySelect.value = 'Stefano';
        } else if (selectedTipo === 'Società WiB') {
            paidByGroup.style.display = 'block';
        } else {
            paidByGroup.style.display = 'none';
        }
    } else if (formType === 'income') {
        const receivedByGroup = document.getElementById('income-received-by-group');
        const receivedBySelect = document.getElementById('income-received-by');
        
        if (selectedTipo === 'Personale - Sonia') {
            receivedByGroup.style.display = 'none';
            receivedBySelect.value = 'Sonia';
        } else if (selectedTipo === 'Personale - Stefano') {
            receivedByGroup.style.display = 'none';
            receivedBySelect.value = 'Stefano';
        } else if (selectedTipo === 'Società WiB') {
            receivedByGroup.style.display = 'block';
        } else {
            receivedByGroup.style.display = 'none';
        }
    }
}
    </script>

</body></html>